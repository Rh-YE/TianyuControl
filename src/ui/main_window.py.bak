"""
ä¸»çª—å£æ¨¡å—
"""
from PyQt5.QtWidgets import (QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
                           QGroupBox, QLabel, QPushButton, QSizePolicy, QSlider)
from PyQt5.QtCore import Qt, QTimer, QDateTime
from PyQt5.QtGui import QImage, QPixmap
from src.ui.components import LabelPair, DeviceControl, InfoGroup, ThemeButton, AngleVisualizer
from src.utils.i18n import i18n
from src.utils.theme_manager import theme_manager
from src.services.astronomy_service import astronomy_service
from src.services.device_service import device_service
from src.services.dss_image_fetcher import DSSImageFetcher
from src.config.settings import TELESCOPE_CONFIG, DEVICES, LAYOUT_CONFIG
from utils import load_config
import os
import time

class MainWindow(QMainWindow):
    def __init__(self, telescope_devices=None):
        super().__init__()
        # åˆ›å»ºä¸­å¿ƒéƒ¨ä»¶
        self.central_widget = QWidget()
        self.setCentralWidget(self.central_widget)
        
        # åˆ›å»ºDSSå›¾åƒè·å–çº¿ç¨‹
        self.dss_fetcher = DSSImageFetcher()
        self.dss_fetcher.image_ready.connect(self.update_dss_image)
        
        # æ ‡è®°æ˜¯å¦å·²æ·»åŠ é»˜è®¤é•œå¤´ç›–è®¾å¤‡
        self.has_added_default_cover_device = False
        
        self.init_ui(telescope_devices)
        self.init_timer()

    def init_ui(self, telescope_devices):
        """åˆå§‹åŒ–UI"""
        self.setWindowTitle(i18n.get_text('telescope_monitor'))
        self.setGeometry(100, 100, 1920, 1080)

        # åˆ›å»ºèœå•æ 
        self.menubar = self.menuBar()
        
        # åˆ›å»ºè¿æ¥èœå•
        self.connect_menu = self.menubar.addMenu(i18n.get_text('connect'))
        
        # åˆ›å»ºè®¾ç½®èœå•
        self.settings_menu = self.menubar.addMenu('è®¾ç½®')
        
        # åˆ›å»ºä¸»é¢˜å­èœå•
        self.theme_menu = self.settings_menu.addMenu('ä¸»é¢˜')
        
        # åˆ›å»ºä¸»é¢˜èœå•é¡¹
        self.light_action = self.theme_menu.addAction('â˜€ï¸ ' + i18n.get_text('light_mode'))
        self.dark_action = self.theme_menu.addAction('ğŸŒ™ ' + i18n.get_text('dark_mode'))
        self.red_action = self.theme_menu.addAction('ğŸ”´ ' + i18n.get_text('red_mode'))
        
        # è®¾ç½®èœå•é¡¹ä¸ºå¯å‹¾é€‰
        self.light_action.setCheckable(True)
        self.dark_action.setCheckable(True)
        self.red_action.setCheckable(True)
        
        # é»˜è®¤é€‰ä¸­æ—¥é—´æ¨¡å¼
        self.light_action.setChecked(True)
        
        # è¿æ¥ä¸»é¢˜èœå•é¡¹çš„ä¿¡å·
        self.light_action.triggered.connect(lambda: self.change_theme('light'))
        self.dark_action.triggered.connect(lambda: self.change_theme('dark'))
        self.red_action.triggered.connect(lambda: self.change_theme('red'))
        
        # æ·»åŠ è¯­è¨€åˆ‡æ¢èœå•é¡¹
        self.language_action = self.settings_menu.addAction(i18n.get_text('language'))
        self.language_action.triggered.connect(self.change_language)
        
        # ä¸»å¸ƒå±€
        main_layout = QVBoxLayout()
        main_layout.setContentsMargins(
            LAYOUT_CONFIG['window_margin'],
            LAYOUT_CONFIG['window_margin'],
            LAYOUT_CONFIG['window_margin'],
            LAYOUT_CONFIG['window_margin']
        )
        main_layout.setSpacing(LAYOUT_CONFIG['content_spacing'])

        content_layout = QHBoxLayout()
        content_layout.setSpacing(LAYOUT_CONFIG['section_spacing'])
        
        # å·¦ä¾§æ 
        left_layout = QVBoxLayout()
        left_layout.setSpacing(LAYOUT_CONFIG['group_spacing'])
        
        # åŸºæœ¬ä¿¡æ¯ç»„
        self.basic_info = InfoGroup('basic_info')
        self.basic_info.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        self.basic_info.add_item('aperture', TELESCOPE_CONFIG['aperture'])
        self.basic_info.add_item('fov', TELESCOPE_CONFIG['field_of_view'])
        self.basic_info.add_item('longitude', f"{TELESCOPE_CONFIG['longitude']}Â°")
        self.basic_info.add_item('latitude', f"{TELESCOPE_CONFIG['latitude']}Â°")
        self.basic_info.add_item('altitude_text', f"{TELESCOPE_CONFIG['altitude']}m")
        left_layout.addWidget(self.basic_info.get_widget())

        # æœ›è¿œé•œçŠ¶æ€ç»„
        self.telescope_status = InfoGroup('telescope_status')
        self.telescope_status.layout.setSpacing(LAYOUT_CONFIG['group_spacing'])
        self.telescope_status.add_item('ra', '12:00:00', 'large-text')
        self.telescope_status.add_item('dec', '+30:00:00', 'large-text')
        self.telescope_status.add_item('alt', '60Â°', 'medium-text')
        self.telescope_status.add_item('az', '120Â°', 'medium-text')
        self.telescope_status.add_item('telescope_state', i18n.get_text('status_unknown'), 'medium-text')
        self.telescope_status.add_item('motor_enable', i18n.get_text('motor_disabled'), 'medium-text')
        self.telescope_status.add_item('cover_status', i18n.get_text('cover_status_unknown'), 'medium-text')
        self.telescope_status.add_item('frame_dec_angle', '0.0Â°', 'medium-text')
        left_layout.addWidget(self.telescope_status.get_widget())
        
        # è®¾å¤‡æ§åˆ¶ç»„ä»¶åˆ—è¡¨
        self.device_controls = []
        
        # æ·»åŠ æœ›è¿œé•œè®¾å¤‡æ§åˆ¶ç»„ä»¶ï¼ˆæ–°çš„å¸¦ä¸‹æ‹‰èœå•çš„ç‰ˆæœ¬ï¼‰
        self.mount_control = DeviceControl('mount', i18n.get_text('mount'))
        if telescope_devices:  # å¦‚æœæœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ›´æ–°åˆ°ä¸‹æ‹‰èœå•
            self.mount_control.update_devices(telescope_devices)
        # è¿æ¥ä½ç½®æ›´æ–°ä¿¡å·
        self.mount_control.signals.location_updated.connect(self.update_location_info)
        # è¿æ¥åæ ‡æ›´æ–°ä¿¡å·
        self.mount_control.signals.coordinates_updated.connect(self.update_coordinates)
        # è¿æ¥çŠ¶æ€æ›´æ–°ä¿¡å·
        self.mount_control.signals.status_updated.connect(self.update_telescope_status)
        # è¿æ¥è®¾å¤‡åˆ—è¡¨æ›´æ–°ä¿¡å·
        self.mount_control.telescope_monitor.devices_updated.connect(self.mount_control.update_devices)
        # æ·»åŠ è¿æ¥çŠ¶æ€å˜åŒ–å›è°ƒ
        self.mount_control.connect_status_changed = self.update_device_connect_status
        self.device_controls.append(self.mount_control)
        
        # æ·»åŠ å…¶ä»–è®¾å¤‡æ§åˆ¶ç»„ä»¶
        other_devices = [
            ('focuser', 'focuser'),
            ('rotator', 'rotator'),
            ('weather', 'weather'),
            ('cover', 'cover'),
            ('dome', 'dome'),  # åœ†é¡¶è®¾å¤‡
            ('cooler', 'cooler'),  # æ–°å¢æ°´å†·æœºè®¾å¤‡
            ('ups', 'ups')  # æ–°å¢UPSç”µæºè®¾å¤‡
        ]
        for device_id, name in other_devices:
            device_control = DeviceControl(device_id, i18n.get_text(device_id))
            if device_id == 'focuser':
                # è¿æ¥ç”µè°ƒç„¦çŠ¶æ€æ›´æ–°ä¿¡å·
                device_control.telescope_monitor.focuser_updated.connect(self.update_focuser_status)
                # è¿æ¥è®¾å¤‡åˆ—è¡¨æ›´æ–°ä¿¡å·
                device_control.telescope_monitor.devices_updated.connect(device_control.update_devices)
                # å¦‚æœæœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ›´æ–°åˆ°ä¸‹æ‹‰èœå•
                if telescope_devices:
                    device_control.update_devices(telescope_devices)
            elif device_id == 'rotator':
                # è¿æ¥æ¶ˆæ—‹å™¨çŠ¶æ€æ›´æ–°ä¿¡å·
                device_control.telescope_monitor.rotator_updated.connect(self.update_rotator_status)
                # è¿æ¥è®¾å¤‡åˆ—è¡¨æ›´æ–°ä¿¡å·
                device_control.telescope_monitor.devices_updated.connect(device_control.update_devices)
                # å¦‚æœæœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ›´æ–°åˆ°ä¸‹æ‹‰èœå•
                if telescope_devices:
                    device_control.update_devices(telescope_devices)
            elif device_id == 'weather':
                # è¿æ¥æ°”è±¡ç«™æ•°æ®æ›´æ–°ä¿¡å·
                if device_control.telescope_monitor:
                    device_control.telescope_monitor.weather_updated.connect(self.update_weather_info)
                    # è¿æ¥è®¾å¤‡åˆ—è¡¨æ›´æ–°ä¿¡å·
                    device_control.telescope_monitor.devices_updated.connect(device_control.update_devices)
                    # å¦‚æœæœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ›´æ–°åˆ°ä¸‹æ‹‰èœå•
                    if telescope_devices:
                        device_control.update_devices(telescope_devices)
                    else:
                        # å¦‚æœæ²¡æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤è®¾å¤‡
                        default_devices = [{
                            'DeviceName': 'ASCOM Observing Conditions Simulator',
                            'DeviceType': 'ObservingConditions',
                            'DeviceNumber': 0,
                            'ApiVersion': '1.0'
                        }]
                        device_control.update_devices(default_devices)
            elif device_id == 'cover':
                # è¿æ¥é•œå¤´ç›–çŠ¶æ€æ›´æ–°ä¿¡å·
                if device_control.telescope_monitor:
                    device_control.telescope_monitor.cover_updated.connect(self.update_cover_status)
                    # è¿æ¥è®¾å¤‡åˆ—è¡¨æ›´æ–°ä¿¡å·
                    device_control.telescope_monitor.devices_updated.connect(device_control.update_devices)
                    # å¦‚æœæœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ›´æ–°åˆ°ä¸‹æ‹‰èœå•
                    if telescope_devices:
                        found_cover_devices = [d for d in telescope_devices if d.get('DeviceType') == 'CoverCalibrator']
                        if found_cover_devices:
                            device_control.update_devices(found_cover_devices)
                            print(f"æ‰¾åˆ°å¹¶æ·»åŠ é•œå¤´ç›–è®¾å¤‡: {len(found_cover_devices)}ä¸ª")
                    else:
                            print("åœ¨è®¾å¤‡åˆ—è¡¨ä¸­æœªæ‰¾åˆ°é•œå¤´ç›–è®¾å¤‡ï¼Œæ·»åŠ é»˜è®¤è®¾å¤‡")
                            # å¦‚æœæ²¡æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤è®¾å¤‡
                            default_devices = [{
                                'DeviceName': 'ASCOM CoverCalibrator Simulator',
                                'DeviceType': 'CoverCalibrator',
                                'DeviceNumber': 0,
                                'ApiVersion': '1.0'
                            }]
                            device_control.update_devices(default_devices)
                else:
                    print("æ²¡æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ·»åŠ é»˜è®¤é•œå¤´ç›–è®¾å¤‡")
                    # å¦‚æœæ²¡æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤è®¾å¤‡
                    default_devices = [{
                        'DeviceName': 'ASCOM CoverCalibrator Simulator',
                        'DeviceType': 'CoverCalibrator',
                        'DeviceNumber': 0,
                        'ApiVersion': '1.0'
                    }]
                    device_control.update_devices(default_devices)
            elif device_id == 'dome':
                # è¿æ¥åœ†é¡¶çŠ¶æ€æ›´æ–°ä¿¡å·
                if device_control.telescope_monitor:
                    device_control.telescope_monitor.dome_updated.connect(self.update_dome_status)
                    # è¿æ¥è®¾å¤‡åˆ—è¡¨æ›´æ–°ä¿¡å·
                    device_control.telescope_monitor.devices_updated.connect(device_control.update_devices)
                    # å¦‚æœæœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ›´æ–°åˆ°ä¸‹æ‹‰èœå•
                    if telescope_devices:
                        device_control.update_devices([d for d in telescope_devices if d.get('DeviceType') == 'Dome'])
                    else:
                        # å¦‚æœæ²¡æœ‰è®¾å¤‡åˆ—è¡¨ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤è®¾å¤‡
                        default_devices = [{
                            'DeviceName': 'ASCOM Dome Simulator',
                            'DeviceType': 'Dome',
                            'DeviceNumber': 0,
                            'ApiVersion': '1.0'
                        }]
                        device_control.update_devices(default_devices)
                    # å¯åŠ¨åœ†é¡¶ç›‘æ§
                    device_control.telescope_monitor.start_dome_monitoring()
            elif device_id == 'cooler':
                # ç‰¹æ®Šå¤„ç†æ°´å†·æœºè®¾å¤‡ï¼ˆä½¿ç”¨ä¸²å£è¿æ¥ï¼‰
                # åˆ›å»ºæ°´å†·æœºè®¾å¤‡æ§åˆ¶å™¨ï¼ˆä¸ä½¿ç”¨ telescope_monitorï¼‰
                device_control.is_serial_device = True
                # è¿æ¥æ°´å†·æœºçŠ¶æ€æ›´æ–°ä¿¡å·
                device_control.signals.status_updated.connect(self.update_cooler_status)
                # è·å–å¯ç”¨ä¸²å£åˆ—è¡¨å¹¶æ›´æ–°åˆ°ä¸‹æ‹‰èœå•
                self.update_serial_ports(device_control)
            elif device_id == 'ups':
                # ç‰¹æ®Šå¤„ç†UPSç”µæºè®¾å¤‡ï¼ˆä½¿ç”¨ä¸²å£è¿æ¥ï¼‰
                # åˆ›å»ºUPSç”µæºè®¾å¤‡æ§åˆ¶å™¨ï¼ˆä¸ä½¿ç”¨ telescope_monitorï¼‰
                device_control.is_serial_device = True
                # è¿æ¥UPSç”µæºçŠ¶æ€æ›´æ–°ä¿¡å·
                device_control.signals.status_updated.connect(self.update_ups_status)
                # è·å–å¯ç”¨ä¸²å£åˆ—è¡¨å¹¶æ›´æ–°åˆ°ä¸‹æ‹‰èœå•
                self.update_serial_ports(device_control)
            
            # æ·»åŠ è¿æ¥çŠ¶æ€å˜åŒ–å›è°ƒ
            device_control.connect_status_changed = self.update_device_connect_status
            self.device_controls.append(device_control)

        # ä¸­é—´æ 
        middle_layout = QVBoxLayout()
        middle_layout.setSpacing(LAYOUT_CONFIG['section_spacing'])

        # åˆ›å»ºä¸»å†…å®¹åŒºæ°´å¹³å¸ƒå±€ï¼ˆå·¦å³ä¸¤æ ï¼‰
        main_content_layout = QHBoxLayout()
        main_content_layout.setSpacing(LAYOUT_CONFIG['section_spacing'])
        
        # å·¦ä¾§å†…å®¹åŒºï¼ˆæ”¾ç½®æœ›è¿œé•œçŠ¶æ€ã€åœ†é¡¶çŠ¶æ€å’Œè°ƒç„¦å™¨çŠ¶æ€ï¼‰
        left_content_layout = QVBoxLayout()
        left_content_layout.setSpacing(LAYOUT_CONFIG['section_spacing'])
        
        # åœ†é¡¶å’Œè°ƒç„¦å™¨çŠ¶æ€æ°´å¹³å¸ƒå±€
        dome_focuser_layout = QHBoxLayout()
        dome_focuser_layout.setSpacing(LAYOUT_CONFIG['widget_spacing'] * 2)  # å¢åŠ é—´è·
        
        # åœ†é¡¶çŠ¶æ€ç»„
        self.dome_status_group = InfoGroup('dome_status')
        self.dome_status_group.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        self.dome_status_group.add_item('dome_azimuth', '0.0Â°', 'medium-text')
        self.dome_status_group.add_item('dome_status', i18n.get_text('dome_status_unknown'), 'medium-text')
        
        # è°ƒç„¦å™¨çŠ¶æ€ç»„ - å¢åŠ å®½åº¦
        self.focuser_status = InfoGroup('focuser_status')
        self.focuser_status.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        self.focuser_status.add_item('position', '34000/60000', 'medium-text')
        self.focuser_status.add_item('temperature', '--Â°C', 'medium-text')
        self.focuser_status.add_item('angle', '0.0Â°', 'medium-text')
        self.focuser_status.add_item('moving', i18n.get_text('moving_yes'))
        
        # è®¾ç½®æœ€å°å®½åº¦ï¼Œç¡®ä¿æ–‡å­—æ˜¾ç¤ºå®Œæ•´
        focuser_widget = self.focuser_status.get_widget()
        focuser_widget.setMinimumWidth(220)  # è¿›ä¸€æ­¥å¢åŠ æœ€å°å®½åº¦
        
        # ä¸ºè°ƒç„¦å™¨çŠ¶æ€æ¡†è®¾ç½®å·¦å³å¤–è¾¹è·ï¼Œç¡®ä¿æ–‡å­—ä¸è¢«é®æŒ¡
        focuser_widget.setContentsMargins(10, 5, 10, 5)
        
        # è®¾ç½®åœ†é¡¶çŠ¶æ€æ¡†çš„æœ€å°å®½åº¦
        dome_widget = self.dome_status_group.get_widget()
        dome_widget.setMinimumWidth(200)
        dome_widget.setContentsMargins(10, 5, 10, 5)
        
        # æ°´å†·æœºçŠ¶æ€ç»„
        self.expanded_cooler_status_group = InfoGroup('cooler_status')
        self.expanded_cooler_status_group.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        self.expanded_cooler_status_group.add_item('cooler_temperature', '--Â°C')
        self.expanded_cooler_status_group.add_item('cooler_running', i18n.get_text('indicator_off'))
        self.expanded_cooler_status_group.add_item('cooler_flow_alarm', i18n.get_text('indicator_off'))
        self.expanded_cooler_status_group.add_item('cooler_temp_alarm', i18n.get_text('indicator_off'))
        self.expanded_cooler_status_group.add_item('cooler_level_alarm', i18n.get_text('indicator_off'))
        self.expanded_cooler_status_group.add_item('cooler_power', i18n.get_text('indicator_off'))
        
        # UPSçŠ¶æ€ç»„
        self.expanded_ups_status_group = InfoGroup('ups_status')
        self.expanded_ups_status_group.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        self.expanded_ups_status_group.add_item('ups_status', i18n.get_text('ups_status_unknown'))
        self.expanded_ups_status_group.add_item('ups_output_voltage', '0.0V')
        self.expanded_ups_status_group.add_item('ups_battery', '0%')
        self.expanded_ups_status_group.add_item('ups_temperature', '0.0Â°C')
        self.expanded_ups_status_group.add_item('ups_health', i18n.get_text('ups_health_normal'))
        self.expanded_ups_status_group.add_item('running_status', i18n.get_text('ups_running_normal'))
        
        # åˆ›å»ºé•œå¤´ç›–æ§åˆ¶ç»„
        self.cover_control_group = InfoGroup('cover_control')
        self.cover_control_group.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])

        # æ·»åŠ æ§åˆ¶æŒ‰é’®å®¹å™¨
        cover_buttons_container = QHBoxLayout()
        cover_buttons_container.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        
        # åˆ›å»ºé•œå¤´ç›–æ‰“å¼€æŒ‰é’®
        self.cover_open_button = QPushButton("æ‰“å¼€é•œå¤´ç›–")
        self.cover_open_button.setMinimumHeight(30)
        self.cover_open_button.setCursor(Qt.PointingHandCursor)
        self.cover_open_button.setProperty('class', 'primary-button')  # æ·»åŠ æ ·å¼ç±»
        self.cover_open_button.clicked.connect(self.open_cover)  # è¿æ¥åˆ°æ‰“å¼€é•œå¤´ç›–å‡½æ•°
        
        # åˆ›å»ºé•œå¤´ç›–å…³é—­æŒ‰é’®
        self.cover_close_button = QPushButton("å…³é—­é•œå¤´ç›–")
        self.cover_close_button.setMinimumHeight(30)
        self.cover_close_button.setCursor(Qt.PointingHandCursor)
        self.cover_close_button.setProperty('class', 'secondary-button')  # æ·»åŠ æ ·å¼ç±»
        self.cover_close_button.clicked.connect(self.close_cover)  # è¿æ¥åˆ°å…³é—­é•œå¤´ç›–å‡½æ•°
        
        # æ·»åŠ æŒ‰é’®åˆ°å®¹å™¨å¸ƒå±€
        cover_buttons_container.addWidget(self.cover_open_button)
        cover_buttons_container.addWidget(self.cover_close_button)
        
        # å°†æŒ‰é’®å®¹å™¨æ·»åŠ åˆ°é•œå¤´ç›–æ§åˆ¶ç»„çš„å¸ƒå±€ä¸­
        self.cover_control_group.layout.addLayout(cover_buttons_container)
        
        # åˆ›å»ºåœ†é¡¶æ§åˆ¶ç»„
        self.dome_control_group = InfoGroup('dome_control')
        self.dome_control_group.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        
        # æ·»åŠ æ§åˆ¶æŒ‰é’®å®¹å™¨
        dome_buttons_container = QHBoxLayout()
        dome_buttons_container.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        
        # åˆ›å»ºåœ†é¡¶å¼€æŒ‰é’®
        self.dome_open_button = QPushButton("åœ†é¡¶å¼€")
        self.dome_open_button.setMinimumHeight(30)
        self.dome_open_button.setCursor(Qt.PointingHandCursor)
        self.dome_open_button.setProperty('class', 'primary-button')  # æ·»åŠ æ ·å¼ç±»
        self.dome_open_button.clicked.connect(self.open_dome_shutter)
        
        # åˆ›å»ºåœ†é¡¶å…³æŒ‰é’®
        self.dome_close_button = QPushButton("åœ†é¡¶å…³")
        self.dome_close_button.setMinimumHeight(30)
        self.dome_close_button.setCursor(Qt.PointingHandCursor)
        self.dome_close_button.setProperty('class', 'secondary-button')  # æ·»åŠ æ ·å¼ç±»
        self.dome_close_button.clicked.connect(self.close_dome_shutter)
        
        # æ·»åŠ æŒ‰é’®åˆ°å®¹å™¨å¸ƒå±€
        dome_buttons_container.addWidget(self.dome_open_button)
        dome_buttons_container.addWidget(self.dome_close_button)
        
        # å°†æŒ‰é’®å®¹å™¨æ·»åŠ åˆ°åœ†é¡¶æ§åˆ¶ç»„çš„å¸ƒå±€ä¸­
        self.dome_control_group.layout.addLayout(dome_buttons_container)
        
        # åˆ›å»ºå·¦ä¾§çŠ¶æ€æ å¸ƒå±€(ç¬¬ä¸€åˆ—)ï¼ŒåŒ…å«åœ†é¡¶+è°ƒç„¦å™¨+æ°´å†·æœº
        status_layout_left = QVBoxLayout()
        status_layout_left.setSpacing(LAYOUT_CONFIG['group_spacing'])
        status_layout_left.addWidget(dome_widget)
        status_layout_left.addWidget(focuser_widget)  # å°†è°ƒç„¦å™¨æ”¾åœ¨åœ†é¡¶å’Œæ°´å†·æœºä¹‹é—´
        status_layout_left.addWidget(self.expanded_cooler_status_group.get_widget())
        
        # åˆ›å»ºå³ä¾§çŠ¶æ€æ å¸ƒå±€(ç¬¬äºŒåˆ—)ï¼ŒåŒ…å«é•œå¤´ç›–æ§åˆ¶ã€åœ†é¡¶æ§åˆ¶å’ŒUPSç”µæºçŠ¶æ€
        status_layout_right = QVBoxLayout()
        status_layout_right.setSpacing(LAYOUT_CONFIG['group_spacing'])
        status_layout_right.addWidget(self.cover_control_group.get_widget())
        status_layout_right.addWidget(self.dome_control_group.get_widget())  # æ·»åŠ åœ†é¡¶æ§åˆ¶æ 
        status_layout_right.addWidget(self.expanded_ups_status_group.get_widget()) # å°†UPSæ”¾åœ¨åœ†é¡¶æ§åˆ¶ä¸‹é¢
        
        # æ·»åŠ åˆ°å·¦ä¾§å†…å®¹åŒºçš„æ°´å¹³å¸ƒå±€ä¸­ï¼Œæ¢å¤ä¸¤åˆ—å¸ƒå±€
        status_container = QHBoxLayout()
        status_container.setSpacing(LAYOUT_CONFIG['section_spacing'])
        status_container.addLayout(status_layout_left, 1)
        status_container.addLayout(status_layout_right, 1)
        
        # æ·»åŠ å¸ƒå±€åˆ°å·¦ä¾§å†…å®¹åŒº
        left_content_layout.addLayout(status_container)
        
        # å°†å·¦ä¾§å†…å®¹åŒºæ·»åŠ åˆ°ä¸»å†…å®¹åŒºå¸ƒå±€
        main_content_layout.addLayout(left_content_layout, 1)  # å†…å®¹åŒºå æ»¡æ•´ä¸ªç©ºé—´
        
        # å°†ä¸»å†…å®¹åŒºå¸ƒå±€æ·»åŠ åˆ°ä¸­é—´æ 
        middle_layout.addLayout(main_content_layout)
        
        # å³ä¾§æ 
        right_layout = QVBoxLayout()
        right_layout.setSpacing(LAYOUT_CONFIG['section_spacing'])

        # åˆ›å»ºä¸Šéƒ¨å¸ƒå±€ï¼ˆä¸¤ä¸ªæ¡†å¹¶æ’ï¼‰
        top_right_layout = QHBoxLayout()
        top_right_layout.setSpacing(LAYOUT_CONFIG['section_spacing'])
        
        # åˆ›å»ºæ¶ˆæ—‹å™¨ç¤ºæ„å›¾æ¡†
        self.rotator_visualizer_group = InfoGroup('rotator_visualizer')
        self.rotator_visualizer_group.layout.setSpacing(LAYOUT_CONFIG['group_spacing'])
        
        # æ·»åŠ DSSå›¾åƒå’Œè§’åº¦å¯è§†åŒ–ç»„ä»¶
        visualizer_layout = QVBoxLayout()  # æ”¹ä¸ºå‚ç›´å¸ƒå±€
        
        # è§’åº¦å¯è§†åŒ–ç»„ä»¶
        self.angle_visualizer = AngleVisualizer()
        self.angle_visualizer.setMinimumSize(200, 200)  # è®¾ç½®æœ€å°å°ºå¯¸
        visualizer_layout.addWidget(self.angle_visualizer)
        
        self.rotator_visualizer_group.layout.addLayout(visualizer_layout)
        
        # æœ›è¿œé•œç›‘æ§ç›¸æœºç»„
        self.telescope_camera = InfoGroup('telescope_monitor_camera')
        self.telescope_camera.layout.setSpacing(LAYOUT_CONFIG['group_spacing'])
        self.telescope_camera_label = QLabel()
        self.telescope_camera_label.setAlignment(Qt.AlignCenter)  # å±…ä¸­å¯¹é½
        self.telescope_camera_label.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)  # å…è®¸æ ‡ç­¾æ‰©å±•å¡«å……å¯ç”¨ç©ºé—´
        # è®¾ç½®æ›´å¤§çš„æœ€å°å°ºå¯¸ï¼Œç¡®ä¿å›¾ç‰‡æœ‰è¶³å¤Ÿæ˜¾ç¤ºç©ºé—´
        self.telescope_camera_label.setMinimumSize(300, 300)
        self.telescope_camera.layout.addWidget(self.telescope_camera_label)
        
        # åŠ è½½å…¨å¤©ç›¸æœºå›¾ç‰‡
        self.update_telescope_camera_image()
        
        # æ·»åŠ ä¸¤ä¸ªæ¡†åˆ°é¡¶éƒ¨å¸ƒå±€ï¼ˆç­‰å®½ï¼‰
        top_right_layout.addWidget(self.rotator_visualizer_group.get_widget(), 1)
        top_right_layout.addWidget(self.telescope_camera.get_widget(), 1)
        
        # å°†é¡¶éƒ¨å¸ƒå±€æ·»åŠ åˆ°å³ä¾§å¸ƒå±€
        right_layout.addLayout(top_right_layout)

        # ç¯å¢ƒç›‘æµ‹ç»„
        self.environment = InfoGroup('environment')
        self.environment.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        self.environment.add_item('cloud_cover', '30%', 'medium-text')
        self.environment.add_item('dew_point', '-15.0Â°C', 'medium-text')
        self.environment.add_item('humidity', '50%', 'medium-text')
        self.environment.add_item('pressure', '1000hPa', 'medium-text')
        self.environment.add_item('rain', '10mm/h', 'medium-text')
        self.environment.add_item('sky_brightness', '10lux', 'medium-text')
        self.environment.add_item('sky_temperature', '-10.0Â°C', 'medium-text')
        self.environment.add_item('seeing', '0.5arcsec', 'medium-text')
        self.environment.add_item('air_temp', '-10.0Â°C', 'medium-text')
        self.environment.add_item('wind_direction', '70Â°', 'medium-text')
        self.environment.add_item('wind_speed', '10m/s', 'medium-text')
        self.environment.add_item('avg_wind_speed', '10m/s', 'medium-text')
        right_layout.addWidget(self.environment.get_widget())

        # æ—¶é—´æ˜¾ç¤ºç»„
        self.time_group = InfoGroup('current_time')
        self.time_group.layout.setSpacing(LAYOUT_CONFIG['widget_spacing'])
        self.time_group.add_item('utc8', '', 'medium-text')
        self.time_group.add_item('sunrise_sunset', '', 'medium-text')
        self.time_group.add_item('twilight', '', 'medium-text')
        self.time_group.add_item('moon_phase', '', 'medium-text')
        self.time_group.add_item('sun_altitude', '', 'medium-text')
        right_layout.addWidget(self.time_group.get_widget())

        # å°†å·¦ä¾§æ æ·»åŠ åˆ°å†…å®¹å¸ƒå±€
        content_layout.addLayout(left_layout, 3)  # å·¦ä¾§æ æ¯”ä¾‹
        
        # å°†ä¸­é—´æ å’Œå³ä¾§æ æ·»åŠ åˆ°å†…å®¹å¸ƒå±€
        content_layout.addLayout(middle_layout, 6)  # ä¸­é—´æ æ¯”ä¾‹
        content_layout.addLayout(right_layout, 3)  # å³ä¾§æ æ¯”ä¾‹
        
        # ç¡®ä¿å°†å†…å®¹å¸ƒå±€æ·»åŠ åˆ°ä¸»å¸ƒå±€
        main_layout.addLayout(content_layout)
        
        # è®¾ç½®ä¸­å¤®éƒ¨ä»¶çš„å¸ƒå±€
        self.central_widget.setLayout(main_layout)

        # è®¾ç½®é»˜è®¤ä¸»é¢˜
        self.change_theme('light')

        # è¿æ¥è®¾å¤‡ç›‘æ§çº¿ç¨‹ä¿¡å·
        if self.mount_control.telescope_monitor:
            self.mount_control.telescope_monitor.coordinates_updated.connect(self.update_coordinates)
            self.mount_control.telescope_monitor.status_updated.connect(self.update_telescope_status)
            self.mount_control.telescope_monitor.devices_updated.connect(self.mount_control.update_devices)
            
            # è¿æ¥æ°”è±¡ç«™æ•°æ®ä¿¡å·
            self.mount_control.telescope_monitor.weather_updated.connect(self.update_weather_info)
            
        # åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œç”¨äºå¼ºåˆ¶æ›´æ–°æ°´å†·æœºçŠ¶æ€
        self.cooler_refresh_timer = QTimer(self)
        self.cooler_refresh_timer.timeout.connect(self.force_refresh_cooler_status)
        self.cooler_refresh_timer.start(5000)  # æ¯5ç§’å¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡

        # ç°åœ¨åˆå§‹åŒ–è¿æ¥èœå• (æ­¤æ—¶self.device_controlså·²ç»è¢«åˆå§‹åŒ–)
        self.init_connect_menu(telescope_devices)

    def init_timer(self):
        """åˆå§‹åŒ–å®šæ—¶å™¨"""
        self.timer = QTimer(self)
        self.timer.timeout.connect(self.update_time_info)
        self.timer.start(1000)  # æ¯ç§’æ›´æ–°
        
        # åˆå§‹åŒ–å…¨å¤©ç›¸æœºå®šæ—¶åˆ·æ–°
        self.telescope_camera_timer = QTimer(self)
        self.telescope_camera_timer.timeout.connect(self.update_telescope_camera_image)
        
        # ä»é…ç½®ä¸­è¯»å–åˆ·æ–°é—´éš”
        config = load_config()
        refresh_interval = config.get("devices", {}).get("allsky_camera", {}).get("refresh_interval", 5)
        self.telescope_camera_timer.start(refresh_interval * 1000)  # è½¬æ¢ä¸ºæ¯«ç§’

    def change_theme(self, theme):
        """åˆ‡æ¢ä¸»é¢˜"""
        # æ›´æ–°ä¸»é¢˜
        theme_manager.switch_theme(theme)
        self.setStyleSheet(theme_manager.get_theme_style())
        
        # æ›´æ–°èœå•é¡¹é€‰ä¸­çŠ¶æ€
        self.light_action.setChecked(theme == 'light')
        self.dark_action.setChecked(theme == 'dark')
        self.red_action.setChecked(theme == 'red')

    def change_language(self):
        """åˆ‡æ¢è¯­è¨€"""
        i18n.switch_language()
        self.update_all_texts()

    def update_all_texts(self):
        """æ›´æ–°æ‰€æœ‰æ–‡æœ¬"""
        # æ›´æ–°çª—å£æ ‡é¢˜
        self.setWindowTitle(i18n.get_text('telescope_monitor'))

        # æ›´æ–°èœå•æ–‡æœ¬
        self.settings_menu.setTitle('è®¾ç½®' if i18n.get_current_language() == 'cn' else 'Settings')
        self.theme_menu.setTitle('ä¸»é¢˜' if i18n.get_current_language() == 'cn' else 'Theme')
        self.light_action.setText('â˜€ï¸ ' + i18n.get_text('light_mode'))
        self.dark_action.setText('ğŸŒ™ ' + i18n.get_text('dark_mode'))
        self.red_action.setText('ğŸ”´ ' + i18n.get_text('red_mode'))
        self.language_action.setText(i18n.get_text('language'))
        
        # æ›´æ–°æ¶ˆæ—‹å™¨ç¤ºæ„å›¾ç»„
        self.rotator_visualizer_group.update_text()
        
        # æ›´æ–°æœ›è¿œé•œçŠ¶æ€ç»„çš„åŠ¨æ€å€¼
        self.telescope_status.update_text()
        self.telescope_status.pairs['telescope_state'].set_value(i18n.get_text('status_unknown'))
        self.telescope_status.pairs['motor_enable'].set_value(i18n.get_text('motor_disabled'))
        self.telescope_status.pairs['cover_status'].set_value(i18n.get_text('cover_status_unknown'))
        
        # æ›´æ–°åœ†é¡¶çŠ¶æ€ç»„çš„åŠ¨æ€å€¼
        self.dome_status_group.update_text()
        self.dome_status_group.pairs['dome_azimuth'].set_value("--")
        self.dome_status_group.pairs['dome_status'].set_value(i18n.get_text('dome_status_unknown'))
        
        # æ›´æ–°åœ†é¡¶æ§åˆ¶ç»„çš„åŠ¨æ€å€¼
        self.dome_control_group.update_text()
        
        # æ›´æ–°é•œå¤´ç›–æ§åˆ¶ç»„çš„åŠ¨æ€å€¼
        self.cover_control_group.update_text()
        
        # æ›´æ–°åœ†é¡¶æ§åˆ¶æŒ‰é’®æ–‡æœ¬
        self.dome_open_button.setText("åœ†é¡¶å¼€")
        self.dome_close_button.setText("åœ†é¡¶å…³")
        
        # æ›´æ–°é•œå¤´ç›–æ§åˆ¶æŒ‰é’®æ–‡æœ¬
        self.cover_open_button.setText("æ‰“å¼€é•œå¤´ç›–")
        self.cover_close_button.setText("å…³é—­é•œå¤´ç›–")
        
        # æ›´æ–°è°ƒç„¦å™¨çŠ¶æ€ç»„çš„åŠ¨æ€å€¼
        self.focuser_status.update_text()
        self.focuser_status.pairs['moving'].set_value(i18n.get_text('moving_yes'))
        
        # æ›´æ–°æœ›è¿œé•œç›‘æ§ç›¸æœºç»„çš„åŠ¨æ€å€¼
        self.telescope_camera.update_text()
        
        # æ›´æ–°æ°´å†·æœºçŠ¶æ€ç»„çš„åŠ¨æ€å€¼
        self.expanded_cooler_status_group.update_text()
        
        # æ›´æ–°UPSçŠ¶æ€ç»„çš„é»˜è®¤å€¼
        self.expanded_ups_status_group.update_text()
        # æ›´æ–°UPSçŠ¶æ€çš„é»˜è®¤å€¼
        self.expanded_ups_status_group.pairs['ups_status'].set_value(i18n.get_text('ups_status_unknown'))
        self.expanded_ups_status_group.pairs['ups_output_voltage'].set_value('0.0V')
        self.expanded_ups_status_group.pairs['ups_battery'].set_value('0%')
        self.expanded_ups_status_group.pairs['ups_temperature'].set_value('0.0Â°C')
        self.expanded_ups_status_group.pairs['ups_health'].set_value(i18n.get_text('ups_health_normal'))
        self.expanded_ups_status_group.pairs['running_status'].set_value(i18n.get_text('ups_running_normal'))
                
        # æ›´æ–°ç¯å¢ƒç›‘æµ‹ç»„
        self.environment.update_text()
        
        # æ›´æ–°æ—¶é—´æ˜¾ç¤ºç»„
        self.time_group.update_text()
        
        # å¼ºåˆ¶æ›´æ–°è®¾å¤‡çŠ¶æ€æ˜¾ç¤º
        for device_control in self.device_controls:
            device_control.update_text()
            
            # å¼ºåˆ¶æ›´æ–°æ°´å†·æœºçŠ¶æ€
            if hasattr(device_control, 'device_id') and device_control.device_id == 'cooler':
                if device_control.is_connected and hasattr(device_control, 'last_status') and device_control.last_status:
                    # ä½¿ç”¨ä¸Šæ¬¡æ¥æ”¶åˆ°çš„çŠ¶æ€é‡æ–°æ›´æ–°UI
                    print(f"å¼ºåˆ¶æ›´æ–°æ°´å†·æœºçŠ¶æ€: {device_control.last_status}")
                    self.update_cooler_status(device_control.last_status)

    def calculate_frame_dec_angle(self):
        """è®¡ç®—æ¡†æ¶èµ¤çº¬è§’åº¦"""
        try:
            # è·å–å½“å‰åæ ‡
            ra_text = self.telescope_status.pairs['ra'].value_label.text()
            dec_text = self.telescope_status.pairs['dec'].value_label.text()
            
            # è½¬æ¢åæ ‡ä¸ºåº¦æ•°
            ra_deg = astronomy_service._parse_time_format(ra_text)
            dec_deg = astronomy_service._parse_time_format(dec_text)
            
            # åªæœ‰å½“åæ ‡å˜åŒ–è¶…è¿‡é˜ˆå€¼æ—¶æ‰æ›´æ–°DSSå›¾åƒ
            if not hasattr(self, 'last_coords') or self.last_coords is None:
                self.last_coords = (ra_deg, dec_deg)
                self.dss_fetcher.set_coordinates(ra_text, dec_text)
            else:
                last_ra, last_dec = self.last_coords
                # å¦‚æœåæ ‡å˜åŒ–è¶…è¿‡0.5åº¦æ‰æ›´æ–°
                if abs(ra_deg - last_ra) > 0.5 or abs(dec_deg - last_dec) > 0.5:
                    self.last_coords = (ra_deg, dec_deg)
                    self.dss_fetcher.set_coordinates(ra_text, dec_text)
            
            # è·å–å½“å‰æ¶ˆæ—‹å™¨è§’åº¦
            rotator_angle = 0
            try:
                # ä»è°ƒç„¦å™¨çŠ¶æ€ç»„çš„angleå­—æ®µè·å–æ¶ˆæ—‹å™¨è§’åº¦
                angle_text = self.focuser_status.pairs['angle'].value_label.text()
                # ç§»é™¤åº¦æ•°ç¬¦å·å¹¶è½¬æ¢ä¸ºæµ®ç‚¹æ•°
                if angle_text and 'Â°' in angle_text:
                    rotator_angle = float(angle_text.replace('Â°', ''))
            except (ValueError, KeyError) as e:
                print(f"è·å–æ¶ˆæ—‹å™¨è§’åº¦å¤±è´¥: {e}")
            
            # è®¡ç®—ç”»å¹…ä¸èµ¤çº¬çš„å¤¹è§’ (Parallactic angle)
            pa = astronomy_service.calculate_parallactic_angle(ra_text, dec_text, rotator_angle)
            if pa is None:
                pa = 0  # è®¡ç®—å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
            
            self.frame_dec_angle = pa
            
            # æ›´æ–°ä¸­é—´æ çš„è§’åº¦æ˜¾ç¤º
            self.telescope_status.pairs['frame_dec_angle'].set_value(f"{pa:.6f}Â°")
            
            # æ›´æ–°è§’åº¦å¯è§†åŒ– - ç”¨èµ¤çº¬è§’åº¦ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ¶ˆæ—‹å™¨è§’åº¦ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°
            self.angle_visualizer.set_angles(dec_deg, rotator_angle)
            
            print(f"å·²æ›´æ–°æ—è¡Œè§’(PA): {pa:.6f}Â°, èµ¤çº¬: {dec_deg}Â°, æ¶ˆæ—‹å™¨è§’åº¦: {rotator_angle}Â°")
            
        except Exception as e:
            print(f"è®¡ç®—æ¡†æ¶èµ¤çº¬è§’åº¦å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()

    def update_dss_image(self, image_path):
        """æ›´æ–°DSSå›¾åƒ"""
        self.angle_visualizer.set_background(image_path)

    def update_time_info(self):
        """æ›´æ–°æ—¶é—´ä¿¡æ¯"""
        # æ›´æ–°æ—¶é—´
        time_info = astronomy_service.get_current_time()
        self.time_group.pairs['utc8'].set_value(time_info['utc8'])
        
        # æ›´æ–°å¤ªé˜³ä¿¡æ¯
        sun_info = astronomy_service.get_sun_info()
        self.time_group.pairs['sunrise_sunset'].set_value(
            f"{sun_info['sunrise']} / {sun_info['sunset']}"
        )
        self.time_group.pairs['sun_altitude'].set_value(sun_info['altitude'])

        # æ›´æ–°æ™¨æ˜ä¿¡æ¯
        twilight_info = astronomy_service.get_twilight_info()
        self.time_group.pairs['twilight'].set_value(
            f"{twilight_info['morning']} / {twilight_info['evening']}"
        )

        # æ›´æ–°æœˆç›¸
        moon_phase = astronomy_service.calculate_moon_phase()
        self.time_group.pairs['moon_phase'].set_value(str(moon_phase))
        
        # æ¯30ç§’æ›´æ–°ä¸€æ¬¡è§’åº¦è®¡ç®—å’Œæ˜Ÿå›¾
        if int(time.time()) % 30 == 0:
            self.calculate_frame_dec_angle() 

    def update_location_info(self, longitude, latitude, elevation):
        """æ›´æ–°ä½ç½®ä¿¡æ¯"""
        self.basic_info.pairs['longitude'].set_value(f"{longitude:.6f}Â°")
        self.basic_info.pairs['latitude'].set_value(f"{latitude:.6f}Â°")
        self.basic_info.pairs['altitude_text'].set_value(f"{elevation:.1f}m")

    def update_coordinates(self, ra, dec, alt, az):
        """æ›´æ–°æœ›è¿œé•œåæ ‡ä¿¡æ¯"""
        # å°†èµ¤ç»è½¬æ¢ä¸ºæ—¶åˆ†ç§’æ ¼å¼
        ra_h = int(ra)
        ra_m = int((ra - ra_h) * 60)
        ra_s = int(((ra - ra_h) * 60 - ra_m) * 60)
        ra_str = f"{ra_h:02d}:{ra_m:02d}:{ra_s:02d}"
        
        # å°†èµ¤çº¬è½¬æ¢ä¸ºåº¦åˆ†ç§’æ ¼å¼
        dec_sign = '+' if dec >= 0 else '-'
        dec_abs = abs(dec)
        dec_d = int(dec_abs)
        dec_m = int((dec_abs - dec_d) * 60)
        dec_s = int(((dec_abs - dec_d) * 60 - dec_m) * 60)
        dec_str = f"{dec_sign}{dec_d:02d}:{dec_m:02d}:{dec_s:02d}"
        
        # æ›´æ–°ç•Œé¢æ˜¾ç¤º
        self.telescope_status.pairs['ra'].set_value(ra_str)
        self.telescope_status.pairs['dec'].set_value(dec_str)
        self.telescope_status.pairs['alt'].set_value(f"{alt:.1f}Â°")
        self.telescope_status.pairs['az'].set_value(f"{az:.1f}Â°") 

    def update_telescope_status(self, status):
        """æ›´æ–°æœ›è¿œé•œçŠ¶æ€"""
        if not status:
            self.telescope_status.pairs['telescope_state'].set_value('Status Unknown')
            self.telescope_status.pairs['telescope_state'].value_label.setProperty('class', 'medium-text status-normal')
            self.telescope_status.pairs['motor_enable'].set_value(i18n.get_text('motor_disabled'))
            self.telescope_status.pairs['motor_enable'].value_label.setProperty('class', 'medium-text status-normal')
            return

        # æ”¶é›†æ‰€æœ‰æ¿€æ´»çš„çŠ¶æ€
        active_states = []
        if status.get('slewing'):
            active_states.append('Slewing')
        if status.get('ispulseguiding'):
            active_states.append('Guiding')
        if status.get('tracking'):
            active_states.append('Tracking')
        if status.get('atpark'):
            active_states.append('AtPark')
        if status.get('athome'):
            active_states.append('AtHome')

        # å¦‚æœæ²¡æœ‰ä»»ä½•çŠ¶æ€æ¿€æ´»ï¼Œæ˜¾ç¤ºæœªçŸ¥çŠ¶æ€
        if not active_states:
            self.telescope_status.pairs['telescope_state'].set_value('Status Unknown')
            self.telescope_status.pairs['telescope_state'].value_label.setProperty('class', 'medium-text status-normal')
            self.telescope_status.pairs['motor_enable'].set_value(i18n.get_text('motor_disabled'))
            self.telescope_status.pairs['motor_enable'].value_label.setProperty('class', 'medium-text status-normal')
            return

        # æ ¹æ®çŠ¶æ€è®¾ç½®æ ·å¼ç±»
        style_class = 'medium-text '  # ä½¿ç”¨ medium-text æ›¿ä»£ status-text
        if 'Slewing' in active_states:
            style_class += 'status-warning'
        elif 'Guiding' in active_states or 'Tracking' in active_states:
            style_class += 'status-success'
        elif 'AtHome' in active_states or 'AtPark' in active_states:
            style_class += 'status-info'
        else:
            style_class += 'status-normal'

        # æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        self.telescope_status.pairs['telescope_state'].set_value(', '.join(active_states))
        self.telescope_status.pairs['telescope_state'].value_label.setProperty('class', style_class)
        self.telescope_status.pairs['telescope_state'].value_label.style().unpolish(self.telescope_status.pairs['telescope_state'].value_label)
        self.telescope_status.pairs['telescope_state'].value_label.style().polish(self.telescope_status.pairs['telescope_state'].value_label)
        
        # æ›´æ–°ç”µæœºä½¿èƒ½çŠ¶æ€
        # å¦‚æœæœ›è¿œé•œåœ¨AtParkçŠ¶æ€ï¼Œåˆ™ç”µæœºæœªä½¿èƒ½ï¼›å¦åˆ™ç”µæœºå·²ä½¿èƒ½
        is_enabled = not status.get('atpark', False)
        motor_status_text = i18n.get_text('motor_enabled') if is_enabled else i18n.get_text('motor_disabled')
        motor_style_class = 'medium-text ' + ('status-success' if is_enabled else 'status-info')
        
        self.telescope_status.pairs['motor_enable'].set_value(motor_status_text)
        self.telescope_status.pairs['motor_enable'].value_label.setProperty('class', motor_style_class)
        self.telescope_status.pairs['motor_enable'].value_label.style().unpolish(self.telescope_status.pairs['motor_enable'].value_label)
        self.telescope_status.pairs['motor_enable'].value_label.style().polish(self.telescope_status.pairs['motor_enable'].value_label)

    def closeEvent(self, event):
        """çª—å£å…³é—­äº‹ä»¶"""
        # åœæ­¢DSSå›¾åƒè·å–çº¿ç¨‹
        self.dss_fetcher.stop()
        self.dss_fetcher.wait()
        
        # åœæ­¢æ‰€æœ‰è®¾å¤‡çš„ç›‘æ§çº¿ç¨‹
        for device_control in self.device_controls:
            if hasattr(device_control, 'telescope_monitor') and device_control.telescope_monitor:
                device_control.telescope_monitor.stop()
                device_control.telescope_monitor.wait()
        
        super().closeEvent(event) 

    def update_focuser_status(self, status):
        """æ›´æ–°ç”µè°ƒç„¦çŠ¶æ€æ˜¾ç¤º"""
        # ç¡®ä¿statusæ˜¯å­—å…¸ä¸”ä¸ä¸ºç©º
        if not status or not isinstance(status, dict):
            log_message("è·å–åˆ°æ— æ•ˆçš„focuserçŠ¶æ€æ•°æ®")
            return
            
        try:
        # æ›´æ–°ä½ç½®
            position = status.get('position', 0)
            maxstep = status.get('maxstep', 60000)
            self.focuser_status.pairs['position'].set_value(f"{position}/{maxstep}")
            
            # æ›´æ–°æ¸©åº¦ - ä½¿ç”¨getæ–¹æ³•é¿å…KeyError
            temperature = status.get('temperature')
            if temperature is not None:
                self.focuser_status.pairs['temperature'].set_value(f"{temperature:.2f}Â°C")
            else:
                self.focuser_status.pairs['temperature'].set_value("--Â°C")
        
        # æ›´æ–°ç§»åŠ¨çŠ¶æ€
            ismoving = status.get('ismoving', False)
            moving_text = i18n.get_text('moving_yes') if ismoving else i18n.get_text('moving_no')
        self.focuser_status.pairs['moving'].set_value(moving_text)
        
        # è®¾ç½®ç§»åŠ¨çŠ¶æ€çš„æ ·å¼
            style_class = 'medium-text ' + ('status-warning' if ismoving else 'status-success')
        self.focuser_status.pairs['moving'].value_label.setProperty('class', style_class)
        self.focuser_status.pairs['moving'].value_label.style().unpolish(self.focuser_status.pairs['moving'].value_label)
        self.focuser_status.pairs['moving'].value_label.style().polish(self.focuser_status.pairs['moving'].value_label)
        except Exception as e:
            log_message(f"æ›´æ–°focuserçŠ¶æ€æ—¶å‡ºé”™: {e}")
            print(f"æ›´æ–°focuserçŠ¶æ€æ—¶å‡ºé”™: {e}, çŠ¶æ€æ•°æ®: {status}")

    def update_rotator_status(self, status):
        """æ›´æ–°æ¶ˆæ—‹å™¨çŠ¶æ€æ˜¾ç¤º"""
        # æ›´æ–°è°ƒç„¦å™¨çŠ¶æ€ç»„ä¸­çš„æ¶ˆæ—‹å™¨è§’åº¦
        self.focuser_status.pairs['angle'].set_value(f"{status['position']:.2f}Â°")
        
        # è·å–å½“å‰åæ ‡ç”¨äºè®¡ç®—PA
        try:
            ra_text = self.telescope_status.pairs['ra'].value_label.text()
            dec_text = self.telescope_status.pairs['dec'].value_label.text()
            
            # è®¡ç®—ç”»å¹…ä¸èµ¤çº¬çš„å¤¹è§’ (Parallactic angle)
            pa = astronomy_service.calculate_parallactic_angle(ra_text, dec_text, status['position'])
            
            if pa is not None:
                # å°†PAå€¼æ›´æ–°åˆ°ç•Œé¢
                self.telescope_status.pairs['frame_dec_angle'].set_value(f"{pa:.6f}Â°")
                
                # æ›´æ–°è§’åº¦å¯è§†åŒ–
                dec_deg = astronomy_service._parse_time_format(dec_text)
                self.angle_visualizer.set_angles(dec_deg, status['position'])
                
                print(f"å·²æ›´æ–°æ—è¡Œè§’(PA): {pa:.6f}Â°, èµ¤çº¬: {dec_deg}Â°, æ¶ˆæ—‹å™¨è§’åº¦: {status['position']}Â°")
            else:
                # å¦‚æœè®¡ç®—PAå¤±è´¥ï¼Œåªä½¿ç”¨æ¶ˆæ—‹å™¨è§’åº¦æ›´æ–°å¯è§†åŒ–
                self.angle_visualizer.set_angles(0, status['position'])
                print(f"æ¶ˆæ—‹å™¨è§’åº¦æ›´æ–°(æ— æ³•è®¡ç®—æ—è¡Œè§’): ä½ç½®={status['position']}Â°")
        except Exception as e:
            # å¦‚æœå‡ºé”™ï¼Œåªä½¿ç”¨æ¶ˆæ—‹å™¨è§’åº¦æ›´æ–°å¯è§†åŒ–
            self.angle_visualizer.set_angles(0, status['position'])
            print(f"æ›´æ–°æ¶ˆæ—‹å™¨çŠ¶æ€å’Œæ—è¡Œè§’è®¡ç®—æ—¶å‡ºé”™: {e}")

    def update_weather_info(self, weather_data):
        """æ›´æ–°æ°”è±¡ç«™ä¿¡æ¯"""
        # æ‰“å°å®Œæ•´çš„æ°”è±¡ç«™æ•°æ®åˆ°æ§åˆ¶å°
        #print("\næ°”è±¡ç«™æ•°æ®æ›´æ–°:")
        for key, value in weather_data.items():
            print(f"  {key}: {value}")
        
        # æ›´æ–°ç¯å¢ƒç›‘æµ‹ç»„ä¸­çš„æ°”è±¡æ•°æ®
        if 'cloudcover' in weather_data and weather_data['cloudcover'] is not None:
            self.environment.pairs['cloud_cover'].set_value(f"{weather_data['cloudcover']:.0f}%")
        else:
            self.environment.pairs['cloud_cover'].set_value("--")
        
        if 'dewpoint' in weather_data and weather_data['dewpoint'] is not None:
            self.environment.pairs['dew_point'].set_value(f"{weather_data['dewpoint']:.2f}Â°C")
        else:
            self.environment.pairs['dew_point'].set_value("--")
            
        if 'humidity' in weather_data and weather_data['humidity'] is not None:
            self.environment.pairs['humidity'].set_value(f"{weather_data['humidity']:.0f}%")
        else:
            self.environment.pairs['humidity'].set_value("--")
            
        if 'pressure' in weather_data and weather_data['pressure'] is not None:
            self.environment.pairs['pressure'].set_value(f"{weather_data['pressure']:.0f}hPa")
        else:
            self.environment.pairs['pressure'].set_value("--")
            
        if 'rainrate' in weather_data and weather_data['rainrate'] is not None:
            self.environment.pairs['rain'].set_value(f"{weather_data['rainrate']:.1f}mm/h")
        else:
            self.environment.pairs['rain'].set_value("--")
            
        if 'skybrightness' in weather_data and weather_data['skybrightness'] is not None:
            self.environment.pairs['sky_brightness'].set_value(f"{weather_data['skybrightness']:.1f}lux")
        else:
            self.environment.pairs['sky_brightness'].set_value("--")
            
        if 'skytemperature' in weather_data and weather_data['skytemperature'] is not None:
            self.environment.pairs['sky_temperature'].set_value(f"{weather_data['skytemperature']:.2f}Â°C")
        else:
            self.environment.pairs['sky_temperature'].set_value("--")
            
        if 'starfwhm' in weather_data and weather_data['starfwhm'] is not None:
            self.environment.pairs['seeing'].set_value(f"{weather_data['starfwhm']:.1f}arcsec")
        else:
            self.environment.pairs['seeing'].set_value("--")
            
        if 'temperature' in weather_data and weather_data['temperature'] is not None:
            self.environment.pairs['air_temp'].set_value(f"{weather_data['temperature']:.2f}Â°C")
        else:
            self.environment.pairs['air_temp'].set_value("--")
            
        if 'winddirection' in weather_data and weather_data['winddirection'] is not None:
            self.environment.pairs['wind_direction'].set_value(f"{weather_data['winddirection']:.0f}Â°")
        else:
            self.environment.pairs['wind_direction'].set_value("--")
            
        if 'windspeed' in weather_data and weather_data['windspeed'] is not None:
            self.environment.pairs['wind_speed'].set_value(f"{weather_data['windspeed']:.1f}m/s")
        else:
            self.environment.pairs['wind_speed'].set_value("--")
            
        if 'windgust' in weather_data and weather_data['windgust'] is not None:
            self.environment.pairs['avg_wind_speed'].set_value(f"{weather_data['windgust']:.1f}m/s")
        else:
            self.environment.pairs['avg_wind_speed'].set_value("--")

    def update_cover_status(self, status):
        """æ›´æ–°é•œå¤´ç›–çŠ¶æ€æ˜¾ç¤º"""
        if not status:
            self.telescope_status.pairs['cover_status'].set_value(i18n.get_text('cover_status_unknown'))
            self.telescope_status.pairs['cover_status'].value_label.setProperty('class', 'medium-text status-normal')
            return

        # è·å–é•œå¤´ç›–çŠ¶æ€çš„åŸå§‹å€¼
        raw_value = status.get('raw_value', 4)  # é»˜è®¤ä¸ºUnknown(4)
        
        # å¦‚æœçŠ¶æ€æ²¡æœ‰å˜åŒ–ï¼Œä¸æ›´æ–°UI
        if hasattr(self, '_last_cover_state') and self._last_cover_state == raw_value:
            return
            
        # ä¿å­˜å½“å‰çŠ¶æ€
        self._last_cover_state = raw_value
        
        # è®¾ç½®çŠ¶æ€æ–‡æœ¬å’Œæ ·å¼
        style_class = 'medium-text '
        if raw_value == 0:  # NotPresent
            status_text = i18n.get_text('cover_status_unknown')
            style_class += 'status-normal'
        elif raw_value == 1:  # Closed
            status_text = i18n.get_text('cover_status_closed')
            style_class += 'status-info'
        elif raw_value == 2:  # Moving
            status_text = i18n.get_text('cover_status_moving')
            style_class += 'status-warning'
        elif raw_value == 3:  # Open
            status_text = i18n.get_text('cover_status_open')
            style_class += 'status-success'
        elif raw_value == 5:  # Error
            status_text = i18n.get_text('cover_status_error')
            style_class += 'status-error'
        else:  # Unknown (4) or any other state
            status_text = i18n.get_text('cover_status_unknown')
            style_class += 'status-normal'

        # æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        self.telescope_status.pairs['cover_status'].set_value(status_text)
        self.telescope_status.pairs['cover_status'].value_label.setProperty('class', style_class)
        self.telescope_status.pairs['cover_status'].value_label.style().unpolish(self.telescope_status.pairs['cover_status'].value_label)
        self.telescope_status.pairs['cover_status'].value_label.style().polish(self.telescope_status.pairs['cover_status'].value_label)

    def update_dome_status(self, status):
        """æ›´æ–°åœ†é¡¶çŠ¶æ€æ˜¾ç¤º"""
        # å¦‚æœè¾“å…¥ä¸ºç©ºæˆ–è€…Noneï¼Œé‡ç½®æ˜¾ç¤º
        if not status:
            self.dome_status_group.pairs['dome_azimuth'].set_value("--")
            self.dome_status_group.pairs['dome_status'].set_value(i18n.get_text('dome_status_unknown'))
            self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', 'medium-text status-normal')
            return

        # è·å–æ–¹ä½è§’
        azimuth = status.get('azimuth')
        if azimuth is not None:
                self.dome_status_group.pairs['dome_azimuth'].set_value(f"{azimuth:.2f}Â°")
        elif azimuth == 0:
                self.dome_status_group.pairs['dome_azimuth'].set_value("--")
        else:
            self.dome_status_group.pairs['dome_azimuth'].set_value("--")
            
        # æ›´æ–°åœ†é¡¶çŠ¶æ€æ–‡æœ¬
        status_text = []
        style_class = 'medium-text '
        
        # æ£€æŸ¥å„ç§çŠ¶æ€
        if status.get('athome'):
            status_text.append(i18n.get_text('dome_at_home'))
            style_class += 'status-info'
        if status.get('atpark'):
            status_text.append(i18n.get_text('dome_at_park'))
            style_class += 'status-info'
        if status.get('slewing'):
            status_text.append(i18n.get_text('dome_slewing'))
            style_class += 'status-warning'
            
        # æ›´æ–°å¤©çª—çŠ¶æ€
        shutter_status = status.get('shutter_status')
        if shutter_status is not None:
            if shutter_status == 0:  # shutterOpen
                status_text.append(i18n.get_text('dome_shutter_open'))
                if not style_class.endswith('status-warning'):
                    style_class += 'status-success'
            elif shutter_status == 1:  # shutterClosed
                status_text.append(i18n.get_text('dome_shutter_closed'))
                if not style_class.endswith('status-warning'):
                    style_class += 'status-info'
            elif shutter_status == 2:  # shutterOpening
                status_text.append(i18n.get_text('dome_shutter_opening'))
                style_class += 'status-warning'
            elif shutter_status == 3:  # shutterClosing
                status_text.append(i18n.get_text('dome_shutter_closing'))
                style_class += 'status-warning'
            elif shutter_status == 4:  # shutterError
                status_text.append(i18n.get_text('dome_shutter_error'))
                style_class += 'status-error'
                
        # å¦‚æœæ²¡æœ‰ä»»ä½•çŠ¶æ€ï¼Œæ˜¾ç¤ºæœªçŸ¥çŠ¶æ€
        if not status_text:
            status_text.append(i18n.get_text('dome_status_unknown'))
            style_class += 'status-normal'

        # æ›´æ–°çŠ¶æ€æ˜¾ç¤ºå’Œæ ·å¼
        self.dome_status_group.pairs['dome_status'].set_value(', '.join(status_text))
        self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', style_class)
        self.dome_status_group.pairs['dome_status'].value_label.style().unpolish(self.dome_status_group.pairs['dome_status'].value_label)
        self.dome_status_group.pairs['dome_status'].value_label.style().polish(self.dome_status_group.pairs['dome_status'].value_label)

    def update_cooler_status(self, status):
        """æ›´æ–°æ°´å†·æœºçŠ¶æ€æ˜¾ç¤º"""
        if not status:
            print("æ°´å†·æœºçŠ¶æ€æ›´æ–°ï¼šæ”¶åˆ°ç©ºçŠ¶æ€")
            return
            
        print(f"æ°´å†·æœºçŠ¶æ€æ›´æ–°æ¥æ”¶ï¼š{status}")
            
        # æ›´æ–°æ¸©åº¦æ˜¾ç¤º
        if 'temperature' in status and status['temperature'] is not None:
            try:
                # æ£€æŸ¥æ˜¯å¦ä¸ºæº¢å‡ºå€¼
                if status['temperature'] == float('inf'):  # ä¸Šæº¢å‡º
                    self.expanded_cooler_status_group.pairs['cooler_temperature'].set_value(i18n.get_text("temperature_overflow"))
                elif status['temperature'] == float('-inf'):  # ä¸‹æº¢å‡º
                    self.expanded_cooler_status_group.pairs['cooler_temperature'].set_value(i18n.get_text("temperature_underflow"))
                else:
                    temp = float(status['temperature'])  # ç›´æ¥ä½¿ç”¨æ¸©åº¦å€¼ï¼Œæ¨¡å—ä¸­å·²å¤„ç†
                    self.expanded_cooler_status_group.pairs['cooler_temperature'].set_value(f"{temp:.2f}Â°C")
                    
                    # æ ¹æ®æ¸©åº¦å€¼è®¾ç½®ä¸åŒçš„æ ·å¼
                    style_class = 'medium-text '
                    if temp > 30:
                        style_class += 'status-error'  # æ¸©åº¦è¿‡é«˜ï¼Œæ˜¾ç¤ºçº¢è‰²
                    elif temp < 10:
                        style_class += 'status-info'   # æ¸©åº¦è¾ƒä½ï¼Œæ˜¾ç¤ºè“è‰²
                    else:
                        style_class += 'status-success'  # æ¸©åº¦æ­£å¸¸ï¼Œæ˜¾ç¤ºç»¿è‰²
                        
                    self.expanded_cooler_status_group.pairs['cooler_temperature'].value_label.setProperty('class', style_class)
                    self.expanded_cooler_status_group.pairs['cooler_temperature'].value_label.style().unpolish(self.expanded_cooler_status_group.pairs['cooler_temperature'].value_label)
                    self.expanded_cooler_status_group.pairs['cooler_temperature'].value_label.style().polish(self.expanded_cooler_status_group.pairs['cooler_temperature'].value_label)
            except (ValueError, TypeError) as e:
                print(f"æ›´æ–°æ°´å†·æœºæ¸©åº¦æ—¶å‡ºé”™: {e}")
                self.expanded_cooler_status_group.pairs['cooler_temperature'].set_value("--Â°C")
        
        # æ›´æ–°çŠ¶æ€æŒ‡ç¤ºç¯æ˜¾ç¤º
        try:
            # ä»å•ç‹¬çš„çŠ¶æ€å­—æ®µè·å–è€Œä¸æ˜¯ä»åŸå§‹çŠ¶æ€ä½è§£æ
            self.update_indicator('cooler_running', status.get('running', False), 'running')      # è¿è¡ŒæŒ‡ç¤ºç¯
            self.update_indicator('cooler_flow_alarm', status.get('flow_alarm', False), 'flow')   # æµé‡æŠ¥è­¦
            self.update_indicator('cooler_temp_alarm', status.get('temp_alarm', False), 'temp')   # æ¸©åº¦æŠ¥è­¦
            self.update_indicator('cooler_level_alarm', status.get('level_alarm', False), 'level') # æ¶²ä½æŠ¥è­¦
            self.update_indicator('cooler_power', status.get('power', False), 'power')            # ç”µæºæŒ‡ç¤ºç¯
            print("æ°´å†·æœºçŠ¶æ€æ›´æ–°å®Œæˆ")
        except Exception as e:
            print(f"æ›´æ–°æ°´å†·æœºçŠ¶æ€æŒ‡ç¤ºç¯æ—¶å‡ºé”™: {e}")
            import traceback
            traceback.print_exc()
    
    def update_indicator(self, indicator_key, bit_value, indicator_type):
        """æ›´æ–°æŒ‡ç¤ºç¯çŠ¶æ€"""
        # è®¾ç½®æŒ‡ç¤ºç¯æ˜¾ç¤ºæ–‡æœ¬
        if bit_value:
            # æ ¹æ®æŒ‡ç¤ºç¯ç±»å‹è®¾ç½®ä¸åŒçš„å¼€å¯çŠ¶æ€æ–‡æœ¬
            if indicator_type in ['flow', 'temp', 'level']:  # æŠ¥è­¦ç±»æŒ‡ç¤ºç¯
                text = i18n.get_text('alarm_on')
                style = 'status-error'  # æŠ¥è­¦çŠ¶æ€ä½¿ç”¨çº¢è‰²
            else:  # æ­£å¸¸æŒ‡ç¤ºç¯
                text = i18n.get_text('indicator_on')
                
                # æ ¹æ®ä¸åŒæŒ‡ç¤ºç¯çŠ¶æ€è®¾ç½®ä¸åŒé¢œè‰²
                if indicator_type == 'running':
                    style = 'status-success'  # è¿è¡ŒçŠ¶æ€ä½¿ç”¨ç»¿è‰²
                elif indicator_type == 'heating':
                    style = 'status-warning'  # åŠ çƒ­çŠ¶æ€ä½¿ç”¨é»„è‰²
                elif indicator_type == 'cooling':
                    style = 'status-info'     # åˆ¶å†·çŠ¶æ€ä½¿ç”¨è“è‰²
                elif indicator_type == 'pump':
                    style = 'status-success'  # æ³µå¾ªç¯çŠ¶æ€ä½¿ç”¨ç»¿è‰²
                elif indicator_type == 'power':
                    style = 'status-success'  # ç”µæºæŒ‡ç¤ºç¯ä½¿ç”¨ç»¿è‰²
                else:
                    style = 'status-normal'   # å…¶ä»–çŠ¶æ€ä½¿ç”¨é»˜è®¤é¢œè‰²
        else:
            # æ‰€æœ‰æŒ‡ç¤ºç¯çš„å…³é—­çŠ¶æ€æ–‡æœ¬
            if indicator_type in ['flow', 'temp', 'level']:  # æŠ¥è­¦ç±»æŒ‡ç¤ºç¯
                text = i18n.get_text('alarm_off')
            else:
                text = i18n.get_text('indicator_off')
            style = 'status-normal'  # å…³é—­çŠ¶æ€ä½¿ç”¨ç°è‰²
        
        # æ›´æ–°æŒ‡ç¤ºç¯çŠ¶æ€æ˜¾ç¤º
        self.expanded_cooler_status_group.pairs[indicator_key].set_value(text)
        self.expanded_cooler_status_group.pairs[indicator_key].value_label.setProperty('class', f'medium-text {style}')
        self.expanded_cooler_status_group.pairs[indicator_key].value_label.style().unpolish(self.expanded_cooler_status_group.pairs[indicator_key].value_label)
        self.expanded_cooler_status_group.pairs[indicator_key].value_label.style().polish(self.expanded_cooler_status_group.pairs[indicator_key].value_label)
    
    def update_serial_ports(self, device_control):
        """æ›´æ–°å¯ç”¨ä¸²å£åˆ—è¡¨"""
        try:
            import serial.tools.list_ports
            # è·å–æ‰€æœ‰å¯ç”¨ä¸²å£
            ports = [p.device for p in serial.tools.list_ports.comports()]
            
            if not ports:
                print("æœªæ‰¾åˆ°å¯ç”¨ä¸²å£è®¾å¤‡")
                device_control.combo.clear()
                device_control.combo.addItem("æ— å¯ç”¨ä¸²å£", None)
                return
                
            print(f"æ‰¾åˆ°å¯ç”¨ä¸²å£: {ports}")
            
            # æ¸…ç©ºä¸‹æ‹‰èœå•
            device_control.combo.clear()
            
            # è¯»å–é…ç½®æ–‡ä»¶ä¸­ä¸Šæ¬¡ä½¿ç”¨çš„ä¸²å£
            config = load_config()
            last_port = config.get("devices", {}).get("cooler", {}).get("port", "")
            
            # å¡«å……ä¸‹æ‹‰èœå•
            index_to_select = 0
            for i, port in enumerate(ports):
                device_control.combo.addItem(port, port)
                # å¦‚æœæ‰¾åˆ°ä¸Šæ¬¡ä½¿ç”¨çš„ä¸²å£ï¼Œé€‰ä¸­å®ƒ
                if port == last_port:
                    index_to_select = i
            
            # é€‰æ‹©ä¸Šæ¬¡ä½¿ç”¨çš„ä¸²å£æˆ–ç¬¬ä¸€ä¸ªå¯ç”¨ä¸²å£
            if device_control.combo.count() > 0:
                device_control.combo.setCurrentIndex(index_to_select)
                
        except ImportError:
            print("è­¦å‘Š: ç¼ºå°‘PySerialåº“ï¼Œæ— æ³•åˆ—å‡ºä¸²å£è®¾å¤‡")
            device_control.combo.clear()
            device_control.combo.addItem("è¯·å®‰è£…PySerial", None)

    def update_ups_status(self, status):
        """æ›´æ–°UPSçŠ¶æ€æ˜¾ç¤º"""
        if not status:
            self.expanded_ups_status_group.pairs['ups_status'].set_value(i18n.get_text('ups_status_unknown'))
            self.expanded_ups_status_group.pairs['ups_status'].value_label.setProperty('class', 'medium-text status-normal')
            self.expanded_ups_status_group.pairs['ups_output_voltage'].set_value('0.0V')
            self.expanded_ups_status_group.pairs['ups_battery'].set_value('0%')
            self.expanded_ups_status_group.pairs['ups_temperature'].set_value('0.0Â°C')
            self.expanded_ups_status_group.pairs['ups_health'].set_value(i18n.get_text('ups_health_normal'))
            self.expanded_ups_status_group.pairs['running_status'].set_value(i18n.get_text('ups_running_normal'))
            return

        # è·å–UPSçŠ¶æ€ä¿¡æ¯
        # UPSçŠ¶æ€ä½ b0: 0=èœ‚é¸£å™¨å…³é—­, 1=èœ‚é¸£å™¨æ‰“å¼€
        #           b1: 0=æ­£å¸¸è¿è¡ŒçŠ¶æ€, 1=æ­£åœ¨å…³æœºæˆ–å·²å…³æœº
        #           b2: 0=éè‡ªæ£€è¿‡ç¨‹ä¸­, 1=æ­£åœ¨è‡ªæ£€
        #           b3: 0=åœ¨çº¿å¼UPS, 1=åå¤‡å¼æˆ–äº’åŠ¨å¼UPS
        #           b4: 0=UPSæ­£å¸¸, 1=UPSæœ‰æ•…éšœ
        #           b5: 0=éæ—è·¯/ç”µæ± å·¥ä½œæ¨¡å¼, 1=æ—è·¯/æ­£åœ¨å‡å‹æˆ–é™å‹
        #           b6: 0=ç”µæ± ç”µå‹ä¸ä½, 1=ç”µæ± ç”µå‹ä½
        #           b7: 0=å¸‚ç”µæ­£å¸¸, 1=å¸‚ç”µå¤±è´¥
        status_text = status.get('status', 'çŠ¶æ€æœªçŸ¥')
        output_voltage = status.get('output_voltage', 0.0)
        battery = status.get('battery', 0)      # ç”µæ± ç”µé‡
        temperature = status.get('temperature', 0.0)
        
        # ç¡®å®šçŠ¶æ€æ ·å¼å’Œæ˜¾ç¤ºæ–‡æœ¬
        style_class = 'medium-text '
        if status_text == "å¸‚ç”µæ­£å¸¸":
            display_text = i18n.get_text('ups_status_normal')
            style_class += 'status-success'
        elif status_text == "ç”µæ± ä¾›ç”µ":
            display_text = i18n.get_text('ups_status_battery')
            style_class += 'status-warning'
        elif status_text == "æ—è·¯ä¾›ç”µ":
            display_text = i18n.get_text('ups_status_bypass')
            style_class += 'status-info'
        elif status_text == "æ•…éšœ":
            display_text = i18n.get_text('ups_status_fault')
            style_class += 'status-error'
        else:  # æœªçŸ¥çŠ¶æ€
            display_text = i18n.get_text('ups_status_unknown')
            style_class += 'status-normal'

        # æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        self.expanded_ups_status_group.pairs['ups_status'].set_value(display_text)
        self.expanded_ups_status_group.pairs['ups_status'].value_label.setProperty('class', style_class)
        self.expanded_ups_status_group.pairs['ups_status'].value_label.style().unpolish(self.expanded_ups_status_group.pairs['ups_status'].value_label)
        self.expanded_ups_status_group.pairs['ups_status'].value_label.style().polish(self.expanded_ups_status_group.pairs['ups_status'].value_label)
        
        # æ›´æ–°ç”µå‹å’Œæ¸©åº¦æ˜¾ç¤º
        self.expanded_ups_status_group.pairs['ups_output_voltage'].set_value(f"{output_voltage:.1f}V")
        self.expanded_ups_status_group.pairs['ups_battery'].set_value(f"{battery}%")
        self.expanded_ups_status_group.pairs['ups_temperature'].set_value(f"{temperature:.2f}Â°C")

        # è®¾ç½®ç”µæ± ç”µé‡æ˜¾ç¤ºæ ·å¼
        battery_style = 'medium-text '
        if battery <= 20:
            battery_style += 'status-error'  # ç”µé‡è¿‡ä½ï¼Œæ˜¾ç¤ºçº¢è‰²
        elif battery <= 50:
            battery_style += 'status-warning'  # ç”µé‡è¾ƒä½ï¼Œæ˜¾ç¤ºé»„è‰²
        else:
            battery_style += 'status-success'  # ç”µé‡æ­£å¸¸ï¼Œæ˜¾ç¤ºç»¿è‰²
        
        self.expanded_ups_status_group.pairs['ups_battery'].value_label.setProperty('class', battery_style)
        self.expanded_ups_status_group.pairs['ups_battery'].value_label.style().unpolish(self.expanded_ups_status_group.pairs['ups_battery'].value_label)
        self.expanded_ups_status_group.pairs['ups_battery'].value_label.style().polish(self.expanded_ups_status_group.pairs['ups_battery'].value_label)
        
        # æ›´æ–°UPSçŠ¶æ€ä½æ˜¾ç¤º
        if 'status_bits' in status and len(status['status_bits']) >= 8:
            status_bits = status['status_bits']
            
            # æ›´æ–°å„çŠ¶æ€ä½æ˜¾ç¤º
            self.update_ups_status_bit('ups_health', status_bits[3], 'status-error' if status_bits[3] == 1 else 'status-success')
            self.update_ups_status_bit('running_status', status_bits[6], 'status-error' if status_bits[6] == 1 else 'status-success')

    def update_ups_status_bit(self, key, bit_value, style_class):
        """æ›´æ–°UPSçŠ¶æ€ä½æ˜¾ç¤º"""
        if key not in self.expanded_ups_status_group.pairs:
            return
            
        # æ ¹æ®ä¸åŒçŠ¶æ€ä½è®¾ç½®æ˜¾ç¤ºæ–‡æœ¬
        if key == 'ups_health':
            text = i18n.get_text('ups_health_fault') if bit_value == 1 else i18n.get_text('ups_health_normal')
        elif key == 'running_status':
            text = i18n.get_text('ups_running_shutdown') if bit_value == 1 else i18n.get_text('ups_running_normal')
        else:
            text = f"{bit_value}"
            
        # æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
        self.expanded_ups_status_group.pairs[key].set_value(text)
        
        # æ›´æ–°æ ·å¼
        self.expanded_ups_status_group.pairs[key].value_label.setProperty('class', f'medium-text {style_class}')
        self.expanded_ups_status_group.pairs[key].value_label.style().unpolish(self.expanded_ups_status_group.pairs[key].value_label)
        self.expanded_ups_status_group.pairs[key].value_label.style().polish(self.expanded_ups_status_group.pairs[key].value_label)

    def force_refresh_cooler_status(self):
        """å¼ºåˆ¶åˆ·æ–°æ°´å†·æœºçŠ¶æ€"""
        for device_control in self.device_controls:
            if hasattr(device_control, 'device_id') and device_control.device_id == 'cooler':
                if device_control.is_connected and hasattr(device_control, 'last_status') and device_control.last_status:
                    # å¦‚æœå·²è¿æ¥ä¸”æœ‰çŠ¶æ€æ•°æ®ï¼Œå¼ºåˆ¶æ›´æ–°UI
                    print(f"å¼ºåˆ¶åˆ·æ–°æ°´å†·æœºçŠ¶æ€: {device_control.last_status}")
                    self.update_cooler_status(device_control.last_status)

    def update_telescope_camera_image(self):
        """æ›´æ–°æœ›è¿œé•œç›‘æ§ç›¸æœºï¼ˆå…¨å¤©ç›¸æœºï¼‰å›¾ç‰‡"""
        try:
            # ä»é…ç½®ä¸­è·å–å…¨å¤©ç›¸æœºé…ç½®
            config = load_config()
            allsky_config = config.get("devices", {}).get("allsky_camera", {})
            
            if not allsky_config.get("enabled", False):
                print("å…¨å¤©ç›¸æœºåŠŸèƒ½å·²ç¦ç”¨")
                return
                
            # è·å–å›¾ç‰‡è·¯å¾„
            image_path = allsky_config.get("image_path", "")
            image_name = allsky_config.get("image_name", "test001")
            image_ext = allsky_config.get("image_extension", ".png")
            
            # æ„å»ºå®Œæ•´çš„å›¾ç‰‡è·¯å¾„
            full_image_path = os.path.join(image_path, image_name + image_ext)
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if not os.path.exists(full_image_path):
                print(f"å…¨å¤©ç›¸æœºå›¾ç‰‡ä¸å­˜åœ¨: {full_image_path}")
                return
                
            # åŠ è½½å›¾ç‰‡
            original_pixmap = QPixmap(full_image_path)
            if original_pixmap.isNull():
                print(f"æ— æ³•åŠ è½½å…¨å¤©ç›¸æœºå›¾ç‰‡: {full_image_path}")
                return
                
            # è·å–åŸå§‹å›¾ç‰‡å°ºå¯¸
            orig_width = original_pixmap.width()
            orig_height = original_pixmap.height()
            
            # è·å–å®¹å™¨å°ºå¯¸
            container = self.telescope_camera.get_widget()
            container_width = container.width() - 20  # å‡å»è¾¹è·
            container_height = container.height() - 40  # å‡å»æ ‡é¢˜å’Œè¾¹è·
            
            # å¦‚æœå®¹å™¨å°ºå¯¸ä¸å¯ç”¨ï¼Œä½¿ç”¨æ ‡ç­¾å°ºå¯¸
            if container_width <= 10 or container_height <= 10:
                container_width = self.telescope_camera_label.width()
                container_height = self.telescope_camera_label.height()
            
            # å¦‚æœå°ºå¯¸ä»ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤å°ºå¯¸
            if container_width <= 10 or container_height <= 10:
                container_width = 260
                container_height = 260
            
            # è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            width_ratio = container_width / orig_width
            height_ratio = container_height / orig_height
            
            # ä½¿ç”¨è¾ƒå°çš„æ¯”ä¾‹æ¥ç¡®ä¿å›¾ç‰‡å®Œå…¨æ˜¾ç¤º
            scale_ratio = min(width_ratio, height_ratio)
            
            # è®¡ç®—æ–°å°ºå¯¸
            new_width = int(orig_width * scale_ratio)
            new_height = int(orig_height * scale_ratio)
            
            # ç¼©æ”¾å›¾ç‰‡
            scaled_pixmap = original_pixmap.scaled(
                new_width, 
                new_height,
                Qt.KeepAspectRatio,
                Qt.SmoothTransformation
            )
            
            # å°†å›¾åƒè®¾ç½®åˆ°æ ‡ç­¾
            self.telescope_camera_label.setPixmap(scaled_pixmap)
            
            print(f"æœ›è¿œé•œç›‘æ§ç›¸æœºå›¾ç‰‡å·²æ›´æ–°: {full_image_path}")
            print(f"å®¹å™¨å°ºå¯¸: {container_width}x{container_height}, å›¾åƒå°ºå¯¸: {new_width}x{new_height}, ç¼©æ”¾æ¯”ä¾‹: {scale_ratio:.2f}")
            
        except Exception as e:
            print(f"æ›´æ–°æœ›è¿œé•œç›‘æ§ç›¸æœºå›¾ç‰‡å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            
    def resizeEvent(self, event):
        """çª—å£å¤§å°æ”¹å˜äº‹ä»¶å¤„ç†"""
        super().resizeEvent(event)
        # ä½¿ç”¨å•æ¬¡è®¡æ—¶å™¨å»¶è¿Ÿæ›´æ–°ï¼Œç¡®ä¿åœ¨å¸ƒå±€è°ƒæ•´å®Œæˆåæ›´æ–°å›¾åƒ
        QTimer.singleShot(100, self.update_telescope_camera_image)

    def init_connect_menu(self, telescope_devices):
        """åˆå§‹åŒ–è¿æ¥èœå•ï¼Œæ˜¾ç¤ºå¯ç”¨çš„è®¾å¤‡"""
        # æ¸…ç©ºè¿æ¥èœå•
        self.connect_menu.clear()
        
        # æ·»åŠ åˆ·æ–°è®¾å¤‡åˆ—è¡¨æŒ‰é’®
        refresh_action = self.connect_menu.addAction(i18n.get_text('refresh_devices'))
        refresh_action.triggered.connect(self.refresh_device_list)
        self.connect_menu.addSeparator()
        
        # è·å–ç³»ç»Ÿå¯ç”¨çš„ä¸²å£åˆ—è¡¨
        serial_ports = self.get_available_serial_ports()
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é•œå¤´ç›–è®¾å¤‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä»coverè®¾å¤‡æ§åˆ¶ç»„ä»¶ä¸­è·å–
        has_cover_device = any(device.get('DeviceType') == 'CoverCalibrator' for device in telescope_devices)
        if not has_cover_device:
            for control in self.device_controls:
                if hasattr(control, 'device_id') and control.device_id == 'cover':
                    # è·å–ä¸‹æ‹‰èœå•ä¸­çš„è®¾å¤‡
                    if control.combo and control.combo.count() > 0:
                        current_index = control.combo.currentIndex()
                        if current_index >= 0:
                            device_data = control.combo.itemData(current_index)
                            if device_data and device_data.get('DeviceType') == 'CoverCalibrator':
                                # æ·»åŠ åˆ°è®¾å¤‡åˆ—è¡¨
                                print(f"å°†ä¸‹æ‹‰èœå•ä¸­çš„é»˜è®¤é•œå¤´ç›–è®¾å¤‡æ·»åŠ åˆ°è¿æ¥èœå•: {device_data.get('DeviceName')}")
                                telescope_devices.append(device_data)
        
        # å¦‚æœæ²¡æœ‰è®¾å¤‡ï¼Œæ·»åŠ "æ— å¯ç”¨è®¾å¤‡"æç¤º
        if not telescope_devices and not serial_ports:
            no_device_action = self.connect_menu.addAction(i18n.get_text('no_devices'))
            no_device_action.setEnabled(False)
            return
            
        # æŒ‰è®¾å¤‡ç±»å‹åˆ†ç»„
        device_types = {
            'Telescope': [],
            'Focuser': [],
            'Rotator': [],
            'ObservingConditions': [],
            'CoverCalibrator': [],
            'Dome': []
        }
        
        # å°†è®¾å¤‡æŒ‰ç±»å‹åˆ†ç»„
        for device in telescope_devices:
            device_type = device.get('DeviceType')
            if device_type in device_types:
                device_types[device_type].append(device)
        
        # è®¾å¤‡ç±»å‹åˆ°UIè®¾å¤‡æ§åˆ¶çš„æ˜ å°„
        type_to_control = {
            'Telescope': 'mount',
            'Focuser': 'focuser',
            'Rotator': 'rotator',
            'ObservingConditions': 'weather',
            'CoverCalibrator': 'cover',
            'Dome': 'dome'
        }
        
        # ä¸ºæ¯ç§è®¾å¤‡ç±»å‹åˆ›å»ºå­èœå•
        for device_type, devices in device_types.items():
            # åˆ›å»ºç±»å‹å­èœå• (å³ä½¿æ²¡æœ‰è®¾å¤‡ä¹Ÿåˆ›å»ºå­èœå•)
                type_menu = self.connect_menu.addMenu(i18n.get_text(type_to_control.get(device_type, device_type.lower())))
                
            if devices:  # å¦‚æœæœ‰è®¾å¤‡
                # ä¸ºæ¯ä¸ªè®¾å¤‡åˆ›å»ºèœå•é¡¹
                for device in devices:
                    device_name = device.get('DeviceName', 'Unknown Device')
                    device_number = device.get('DeviceNumber', 0)
                    
                    # åˆ›å»ºå¯å‹¾é€‰çš„èœå•é¡¹
                    device_action = type_menu.addAction(f"{device_name} #{device_number}")
                    device_action.setCheckable(True)
                    
                    # è®¾ç½®ç”¨æˆ·æ•°æ®ä»¥è¯†åˆ«è®¾å¤‡
                    device_action.setData({
                        'device_type': device_type,
                        'device_number': device_number,
                        'device_name': device_name,
                        'control_id': type_to_control.get(device_type, device_type.lower())
                    })
                    
                    # è¿æ¥èœå•é¡¹ç‚¹å‡»ä¿¡å·
                    device_action.triggered.connect(self.toggle_device_connection)
                    
                    # æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²è¿æ¥ï¼Œè®¾ç½®å‹¾é€‰çŠ¶æ€
                    control_id = type_to_control.get(device_type, device_type.lower())
                    for control in self.device_controls:
                        if hasattr(control, 'device_id') and control.device_id == control_id:
                            if control.is_connected:
                                # å¦‚æœå·²ç»è¿æ¥äº†è¯¥ç±»å‹çš„è®¾å¤‡ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯è¿™ä¸ªè®¾å¤‡
                                current_index = control.combo.currentIndex()
                                if current_index >= 0:
                                    current_device = control.combo.itemData(current_index)
                                    if current_device and current_device.get('DeviceNumber') == device_number:
                                        device_action.setChecked(True)
            else:  # å¦‚æœæ²¡æœ‰è®¾å¤‡ï¼Œæ˜¾ç¤º"æ— è®¾å¤‡"ä¿¡æ¯
                # ç‰¹æ®Šå¤„ç†CoverCalibratorç±»å‹
                if device_type == 'CoverCalibrator':
                    # ç›´æ¥æ·»åŠ ä¸€ä¸ªé»˜è®¤è®¾å¤‡é€‰é¡¹ï¼Œè€Œä¸æ˜¯æ˜¾ç¤º"æ— è®¾å¤‡"
                    device_name = "ASCOM CoverCalibrator Simulator"
                    device_number = 0
                    
                    # åˆ›å»ºå¯å‹¾é€‰çš„èœå•é¡¹
                    device_action = type_menu.addAction(f"{device_name} #{device_number}")
                    device_action.setCheckable(True)
                    
                    # è®¾ç½®ç”¨æˆ·æ•°æ®ä»¥è¯†åˆ«è®¾å¤‡
                    device_action.setData({
                        'device_type': device_type,
                        'device_number': device_number,
                        'device_name': device_name,
                        'control_id': type_to_control.get(device_type, device_type.lower())
                    })
                    
                    # è¿æ¥èœå•é¡¹ç‚¹å‡»ä¿¡å·
                    device_action.triggered.connect(self.toggle_device_connection)
                    
                    print("å·²åœ¨è¿æ¥èœå•ä¸­æ·»åŠ é»˜è®¤CoverCalibratorè®¾å¤‡")
                else:
                    # å…¶ä»–è®¾å¤‡ç±»å‹æ˜¾ç¤º"æ— è®¾å¤‡"
                    no_device_action = type_menu.addAction(i18n.get_text('no_devices'))
                    no_device_action.setEnabled(False)
                
                # ä¸ºé•œå¤´ç›–è®¾å¤‡æ·»åŠ æ‰‹åŠ¨åˆå§‹åŒ–é€‰é¡¹
                if device_type == 'CoverCalibrator':
                    type_menu.addSeparator()
                    init_cover_action = type_menu.addAction("åˆ·æ–°é•œå¤´ç›–è®¾å¤‡")
                    init_cover_action.triggered.connect(self.add_manual_cover_device)
        
        # æ·»åŠ ä¸²å£è®¾å¤‡èœå•
        if serial_ports:
            # æ·»åŠ æ°´å†·æœºèœå•
            cooler_menu = self.connect_menu.addMenu(i18n.get_text('cooler'))
            
            # æ·»åŠ UPSç”µæºèœå•
            ups_menu = self.connect_menu.addMenu(i18n.get_text('ups'))
            
            # ä¸ºæ¯ä¸ªä¸²å£æ·»åŠ èœå•é¡¹
            for port in serial_ports:
                # æ°´å†·æœºèœå•é¡¹
                cooler_action = cooler_menu.addAction(f"{port}")
                cooler_action.setCheckable(True)
                cooler_action.setData({
                    'device_type': 'SerialPort',
                    'port': port,
                    'control_id': 'cooler'
                })
                cooler_action.triggered.connect(self.toggle_serial_connection)
                
                # UPSç”µæºèœå•é¡¹
                ups_action = ups_menu.addAction(f"{port}")
                ups_action.setCheckable(True)
                ups_action.setData({
                    'device_type': 'SerialPort',
                    'port': port,
                    'control_id': 'ups'
                })
                ups_action.triggered.connect(self.toggle_serial_connection)
                
                # æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
                for control in self.device_controls:
                    if hasattr(control, 'device_id') and control.device_id in ['cooler', 'ups']:
                        if control.is_connected and hasattr(control, 'serial_connection'):
                            current_port = control.combo.currentText()
                            if current_port == port:
                                if control.device_id == 'cooler':
                                    cooler_action.setChecked(True)
                                elif control.device_id == 'ups':
                                    ups_action.setChecked(True)
        else:
            # å¦‚æœæ²¡æœ‰ä¸²å£è®¾å¤‡ï¼Œæ·»åŠ æ°´å†·æœºå’ŒUPSèœå•ï¼Œä½†æ˜¾ç¤ºæ— è®¾å¤‡ä¿¡æ¯
            cooler_menu = self.connect_menu.addMenu(i18n.get_text('cooler'))
            ups_menu = self.connect_menu.addMenu(i18n.get_text('ups'))
            
            no_serial_action = cooler_menu.addAction(i18n.get_text('no_serial_ports'))
            no_serial_action.setEnabled(False)
            
            no_serial_action_ups = ups_menu.addAction(i18n.get_text('no_serial_ports'))
            no_serial_action_ups.setEnabled(False)
    
    def get_available_serial_ports(self):
        """è·å–ç³»ç»Ÿå¯ç”¨çš„ä¸²å£åˆ—è¡¨"""
        try:
            import serial.tools.list_ports
            ports = [p.device for p in serial.tools.list_ports.comports()]
            print(f"æ‰¾åˆ°å¯ç”¨ä¸²å£: {ports}")
            return ports
        except ImportError:
            print("è­¦å‘Š: ç¼ºå°‘PySerialåº“ï¼Œæ— æ³•åˆ—å‡ºä¸²å£è®¾å¤‡")
            return []
        except Exception as e:
            print(f"è·å–ä¸²å£åˆ—è¡¨æ—¶å‡ºé”™: {e}")
            return []
    
    def refresh_device_list(self):
        """åˆ·æ–°è®¾å¤‡åˆ—è¡¨"""
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„AlpacaClientæ¥æœç´¢è®¾å¤‡
        from api_client import AlpacaClient
        client = AlpacaClient()
        
        # æœç´¢æ‰€æœ‰ç±»å‹çš„è®¾å¤‡
        devices = client.find_devices()
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é•œå¤´ç›–è®¾å¤‡
        has_cover_device = any(device.get('DeviceType') == 'CoverCalibrator' for device in devices)
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°é•œå¤´ç›–è®¾å¤‡ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤è®¾å¤‡
        if not has_cover_device:
            # æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„é•œå¤´ç›–è®¾å¤‡
            default_cover_device = {
                'DeviceName': 'ASCOM CoverCalibrator Simulator',
                'DeviceType': 'CoverCalibrator',
                'DeviceNumber': 0,
                'ApiVersion': '1.0'
            }
            devices.append(default_cover_device)
            print("æœªæ‰¾åˆ°é•œå¤´ç›–è®¾å¤‡ï¼Œæ·»åŠ é»˜è®¤è®¾å¤‡åˆ°è®¾å¤‡åˆ—è¡¨")
        
        # æ›´æ–°è¿æ¥èœå•
        self.init_connect_menu(devices)
        
        # æ›´æ–°è®¾å¤‡æ§åˆ¶ç»„ä»¶ä¸­çš„è®¾å¤‡åˆ—è¡¨
        for control in self.device_controls:
            if hasattr(control, 'update_devices'):
                if control.device_id == 'cover':
                    # ä¸ºcoverè®¾å¤‡æ§åˆ¶ç»„ä»¶ç­›é€‰å‡ºCoverCalibratorç±»å‹çš„è®¾å¤‡
                    cover_devices = [d for d in devices if d.get('DeviceType') == 'CoverCalibrator']
                    if cover_devices:
                        control.update_devices(cover_devices)
                    else:
                        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ·»åŠ é»˜è®¤è®¾å¤‡
                        control.update_devices([default_cover_device])
                else:
                control.update_devices(devices)
    
    def toggle_device_connection(self):
        """åˆ‡æ¢è®¾å¤‡è¿æ¥çŠ¶æ€"""
        # è·å–è§¦å‘è¯¥å‡½æ•°çš„åŠ¨ä½œ
        action = self.sender()
        if not action or not action.data():
            return
            
        # è·å–è®¾å¤‡ä¿¡æ¯
        device_data = action.data()
        control_id = device_data.get('control_id')
        
        # æ‰¾åˆ°å¯¹åº”çš„è®¾å¤‡æ§åˆ¶ç»„ä»¶
        for control in self.device_controls:
            if hasattr(control, 'device_id') and control.device_id == control_id:
                # å¦‚æœè®¾å¤‡ç±»å‹åŒ¹é…ï¼Œåˆ‡æ¢è¿æ¥çŠ¶æ€
                
                # å¦‚æœè®¾å¤‡å·²è¿æ¥ä¸”åŠ¨ä½œè¢«å‹¾é€‰ï¼Œä¸åšä»»ä½•äº‹
                if control.is_connected and action.isChecked():
                    return
                    
                # å¦‚æœè®¾å¤‡å·²è¿æ¥ä½†åŠ¨ä½œè¢«å–æ¶ˆå‹¾é€‰ï¼Œæ–­å¼€è¿æ¥
                if control.is_connected and not action.isChecked():
                    control.toggle_connection()  # æ–­å¼€è¿æ¥
                    return
                    
                # å¦‚æœè®¾å¤‡æœªè¿æ¥ä½†åŠ¨ä½œè¢«å‹¾é€‰ï¼Œè¿æ¥è®¾å¤‡
                if not control.is_connected and action.isChecked():
                    # å…ˆåœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©å¯¹åº”çš„è®¾å¤‡
                    device_number = device_data.get('device_number')
                    for i in range(control.combo.count()):
                        item_data = control.combo.itemData(i)
                        if item_data and item_data.get('DeviceNumber') == device_number:
                            control.combo.setCurrentIndex(i)
                            break
                    
                    # è¿æ¥è®¾å¤‡
                    control.toggle_connection()
                    
                    # å¦‚æœè¿æ¥æˆåŠŸï¼Œæ›´æ–°å‹¾é€‰çŠ¶æ€
                    action.setChecked(control.is_connected)
                    return
    
    def toggle_serial_connection(self):
        """åˆ‡æ¢ä¸²å£è®¾å¤‡è¿æ¥çŠ¶æ€"""
        # è·å–è§¦å‘è¯¥å‡½æ•°çš„åŠ¨ä½œ
        action = self.sender()
        if not action or not action.data():
            return
            
        # è·å–è®¾å¤‡ä¿¡æ¯
        device_data = action.data()
        control_id = device_data.get('control_id')
        port = device_data.get('port')
        
        if not control_id or not port:
            return
            
        # æ‰¾åˆ°å¯¹åº”çš„è®¾å¤‡æ§åˆ¶ç»„ä»¶
        for control in self.device_controls:
            if hasattr(control, 'device_id') and control.device_id == control_id:
                # å¦‚æœè®¾å¤‡ç±»å‹åŒ¹é…ï¼Œåˆ‡æ¢è¿æ¥çŠ¶æ€
                
                # å¦‚æœè®¾å¤‡å·²è¿æ¥ä¸”åŠ¨ä½œè¢«å‹¾é€‰ï¼Œä¸åšä»»ä½•äº‹
                if control.is_connected and action.isChecked():
                    return
                    
                # å¦‚æœè®¾å¤‡å·²è¿æ¥ä½†åŠ¨ä½œè¢«å–æ¶ˆå‹¾é€‰ï¼Œæ–­å¼€è¿æ¥
                if control.is_connected and not action.isChecked():
                    control.toggle_connection()  # æ–­å¼€è¿æ¥
                    return
                    
                # å¦‚æœè®¾å¤‡æœªè¿æ¥ä½†åŠ¨ä½œè¢«å‹¾é€‰ï¼Œè¿æ¥è®¾å¤‡
                if not control.is_connected and action.isChecked():
                    # å…ˆåœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©å¯¹åº”çš„ä¸²å£
                    for i in range(control.combo.count()):
                        if control.combo.itemText(i) == port:
                            control.combo.setCurrentIndex(i)
                            break
                    
                    # è¿æ¥è®¾å¤‡
                    control.toggle_connection()
                    
                    # å¦‚æœè¿æ¥æˆåŠŸï¼Œæ›´æ–°å‹¾é€‰çŠ¶æ€
                    action.setChecked(control.is_connected)
                    
                    # å–æ¶ˆå…¶ä»–ä¸²å£çš„å‹¾é€‰çŠ¶æ€
                    if control.is_connected:
                        menu = action.parentWidget()
                        if menu:
                            for other_action in menu.actions():
                                if other_action != action and other_action.isCheckable():
                                    other_action.setChecked(False)
                    return
    
    def update_device_connect_status(self, device_id, is_connected, device_data):
        """æ›´æ–°è®¾å¤‡è¿æ¥çŠ¶æ€ï¼ŒåŒæ­¥èœå•é¡¹å‹¾é€‰çŠ¶æ€"""
        # å¦‚æœæ²¡æœ‰è®¾å¤‡æ•°æ®ï¼Œä¸è¿›è¡Œå¤„ç†
        if not device_data:
            return
            
        # å¤„ç†ä¸²å£è®¾å¤‡çš„æƒ…å†µ - device_dataå¯èƒ½æ˜¯å­—ç¬¦ä¸²(ç«¯å£å)
        if isinstance(device_data, str):
            # ä¸²å£è®¾å¤‡(UPSå’Œæ°´å†·æœº)çš„å¤„ç†
            for action in self.connect_menu.actions():
                if action.menu() and action.menu().title() in [i18n.get_text('cooler'), i18n.get_text('ups')]:
                    for device_action in action.menu().actions():
                        if device_action.data():
                            action_data = device_action.data()
                            if (action_data.get('control_id') == device_id and 
                                action_data.get('port') == device_data):
                                # æ›´æ–°å‹¾é€‰çŠ¶æ€
                                device_action.setChecked(is_connected)
                                return
            return
            
        # ä»¥ä¸‹å¤„ç†ASCOMè®¾å¤‡
        try:
            # è·å–è®¾å¤‡ç±»å‹å’Œè®¾å¤‡å·
            device_type = device_data.get('DeviceType')
            device_number = device_data.get('DeviceNumber')
            
            # å¦‚æœæ²¡æœ‰è®¾å¤‡ç±»å‹æˆ–è®¾å¤‡å·ï¼Œä¸è¿›è¡Œå¤„ç†
            if not device_type or device_number is None:
                return
                
            # æŸ¥æ‰¾å¯¹åº”çš„èœå•é¡¹å¹¶æ›´æ–°å‹¾é€‰çŠ¶æ€
            for action in self.connect_menu.actions():
                if action.menu():  # å¦‚æœæ˜¯å­èœå•
                    for device_action in action.menu().actions():
                        if device_action.data():
                            action_data = device_action.data()
                            if (action_data.get('device_type') == device_type and 
                                action_data.get('device_number') == device_number):
                                # æ›´æ–°å‹¾é€‰çŠ¶æ€
                                device_action.setChecked(is_connected)
                                return
        except Exception as e:
            print(f"æ›´æ–°è®¾å¤‡è¿æ¥çŠ¶æ€æ—¶å‡ºé”™: {e}")

    def open_dome_shutter(self):
        """æ‰“å¼€åœ†é¡¶"""
        # æŸ¥æ‰¾æ˜¯å¦æœ‰å·²è¿æ¥çš„åœ†é¡¶è®¾å¤‡
        dome_device = None
        device_number = 0
        
        for control in self.device_controls:
            if hasattr(control, 'device_id') and control.device_id == 'dome' and control.is_connected:
                dome_device = control
                # è·å–è®¾å¤‡å·
                current_index = control.combo.currentIndex()
                if current_index >= 0:
                    device_data = control.combo.itemData(current_index)
                    if device_data and 'DeviceNumber' in device_data:
                        device_number = device_data['DeviceNumber']
                break
        
        if not dome_device:
            print("æœªæ‰¾åˆ°å·²è¿æ¥çš„åœ†é¡¶è®¾å¤‡")
            return
        
        print(f"å‡†å¤‡æ‰“å¼€åœ†é¡¶å¤©çª—ï¼Œè®¾å¤‡å·ï¼š{device_number}")
            
        # æ›´æ–°UIæ˜¾ç¤ºï¼Œè¡¨ç¤ºæ­£åœ¨æ“ä½œ
        self.dome_status_group.pairs['dome_status'].set_value("æ­£åœ¨æ‰“å¼€åœ†é¡¶...")
        self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', 'medium-text status-warning')
        self.dome_status_group.pairs['dome_status'].value_label.style().unpolish(self.dome_status_group.pairs['dome_status'].value_label)
        self.dome_status_group.pairs['dome_status'].value_label.style().polish(self.dome_status_group.pairs['dome_status'].value_label)
        print("å·²æ›´æ–°UIçŠ¶æ€ä¸º'æ­£åœ¨æ‰“å¼€åœ†é¡¶...'")
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        self.dome_open_button.setEnabled(False)
        self.dome_close_button.setEnabled(False)
        print("å·²ç¦ç”¨åœ†é¡¶å¼€å…³æŒ‰é’®")
        
        try:
            # åˆ›å»ºAlpacaClientå®ä¾‹
            print("å¼€å§‹å¯¼å…¥AlpacaClient...")
            import time
            start_time = time.time()
            from api_client import AlpacaClient
            from utils import load_config
            print(f"å¯¼å…¥AlpacaClientå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            print("å¼€å§‹åˆ›å»ºAlpacaClientå®ä¾‹...")
            start_time = time.time()
            config = load_config()
            base_url = config.get("devices", {}).get("dome", {}).get("api_url")
            if not base_url:
                base_url = "http://202.127.24.217:11111"  # é»˜è®¤ URL
            print(f"ä½¿ç”¨API URL: {base_url}")
            client = AlpacaClient(base_url=base_url)
            print(f"åˆ›å»ºAlpacaClientå®ä¾‹å®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            # è°ƒç”¨APIæ‰“å¼€åœ†é¡¶
            print(f"å¼€å§‹è°ƒç”¨APIæ‰“å¼€åœ†é¡¶ï¼Œè®¾å¤‡å·ï¼š{device_number}...")
            start_time = time.time()
            success = client.open_dome_shutter(device_number)
            print(f"è°ƒç”¨APIå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’ï¼Œç»“æœï¼š{success}")
            
            if success:
                print(f"æˆåŠŸå‘é€æ‰“å¼€åœ†é¡¶å‘½ä»¤ï¼Œè®¾å¤‡å·: {device_number}")
            else:
                print(f"å‘é€æ‰“å¼€åœ†é¡¶å‘½ä»¤å¤±è´¥ï¼Œè®¾å¤‡å·: {device_number}")
                # æ¢å¤UIçŠ¶æ€
                self.dome_status_group.pairs['dome_status'].set_value("æ‰“å¼€åœ†é¡¶å¤±è´¥")
                self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', 'medium-text status-error')
                self.dome_status_group.pairs['dome_status'].value_label.style().unpolish(self.dome_status_group.pairs['dome_status'].value_label)
                self.dome_status_group.pairs['dome_status'].value_label.style().polish(self.dome_status_group.pairs['dome_status'].value_label)
        except Exception as e:
            print(f"æ‰“å¼€åœ†é¡¶æ—¶å‡ºé”™: {str(e)}")
            import traceback
            traceback.print_exc()
            # æ¢å¤UIçŠ¶æ€
            self.dome_status_group.pairs['dome_status'].set_value(f"é”™è¯¯: {str(e)}")
            self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', 'medium-text status-error')
            self.dome_status_group.pairs['dome_status'].value_label.style().unpolish(self.dome_status_group.pairs['dome_status'].value_label)
            self.dome_status_group.pairs['dome_status'].value_label.style().polish(self.dome_status_group.pairs['dome_status'].value_label)
        finally:
            # é‡æ–°å¯ç”¨æŒ‰é’®
            print("é‡æ–°å¯ç”¨åœ†é¡¶å¼€å…³æŒ‰é’®")
            self.dome_open_button.setEnabled(True)
            self.dome_close_button.setEnabled(True)

    def close_dome_shutter(self):
        """å…³é—­åœ†é¡¶"""
        # æŸ¥æ‰¾æ˜¯å¦æœ‰å·²è¿æ¥çš„åœ†é¡¶è®¾å¤‡
        dome_device = None
        device_number = 0
        
        for control in self.device_controls:
            if hasattr(control, 'device_id') and control.device_id == 'dome' and control.is_connected:
                dome_device = control
                # è·å–è®¾å¤‡å·
                current_index = control.combo.currentIndex()
                if current_index >= 0:
                    device_data = control.combo.itemData(current_index)
                    if device_data and 'DeviceNumber' in device_data:
                        device_number = device_data['DeviceNumber']
                break
        
        if not dome_device:
            print("æœªæ‰¾åˆ°å·²è¿æ¥çš„åœ†é¡¶è®¾å¤‡")
            return
            
        print(f"å‡†å¤‡å…³é—­åœ†é¡¶å¤©çª—ï¼Œè®¾å¤‡å·ï¼š{device_number}")
            
        # æ›´æ–°UIæ˜¾ç¤ºï¼Œè¡¨ç¤ºæ­£åœ¨æ“ä½œ
        self.dome_status_group.pairs['dome_status'].set_value("æ­£åœ¨å…³é—­åœ†é¡¶...")
        self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', 'medium-text status-warning')
        self.dome_status_group.pairs['dome_status'].value_label.style().unpolish(self.dome_status_group.pairs['dome_status'].value_label)
        self.dome_status_group.pairs['dome_status'].value_label.style().polish(self.dome_status_group.pairs['dome_status'].value_label)
        print("å·²æ›´æ–°UIçŠ¶æ€ä¸º'æ­£åœ¨å…³é—­åœ†é¡¶...'")
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        self.dome_open_button.setEnabled(False)
        self.dome_close_button.setEnabled(False)
        print("å·²ç¦ç”¨åœ†é¡¶å¼€å…³æŒ‰é’®")
        
        try:
            # åˆ›å»ºAlpacaClientå®ä¾‹
            print("å¼€å§‹å¯¼å…¥AlpacaClient...")
            import time
            start_time = time.time()
            from api_client import AlpacaClient
            from utils import load_config
            print(f"å¯¼å…¥AlpacaClientå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            print("å¼€å§‹åˆ›å»ºAlpacaClientå®ä¾‹...")
            start_time = time.time()
            config = load_config()
            base_url = config.get("devices", {}).get("dome", {}).get("api_url")
            if not base_url:
                base_url = "http://202.127.24.217:11111"  # é»˜è®¤ URL
            print(f"ä½¿ç”¨API URL: {base_url}")
            client = AlpacaClient(base_url=base_url)
            print(f"åˆ›å»ºAlpacaClientå®ä¾‹å®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            # è°ƒç”¨APIå…³é—­åœ†é¡¶
            print(f"å¼€å§‹è°ƒç”¨APIå…³é—­åœ†é¡¶ï¼Œè®¾å¤‡å·ï¼š{device_number}...")
            start_time = time.time()
            success = client.close_dome_shutter(device_number)
            print(f"è°ƒç”¨APIå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’ï¼Œç»“æœï¼š{success}")
            
            if success:
                print(f"æˆåŠŸå‘é€å…³é—­åœ†é¡¶å‘½ä»¤ï¼Œè®¾å¤‡å·: {device_number}")
            else:
                print(f"å‘é€å…³é—­åœ†é¡¶å‘½ä»¤å¤±è´¥ï¼Œè®¾å¤‡å·: {device_number}")
                # æ¢å¤UIçŠ¶æ€
                self.dome_status_group.pairs['dome_status'].set_value("å…³é—­åœ†é¡¶å¤±è´¥")
                self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', 'medium-text status-error')
                self.dome_status_group.pairs['dome_status'].value_label.style().unpolish(self.dome_status_group.pairs['dome_status'].value_label)
                self.dome_status_group.pairs['dome_status'].value_label.style().polish(self.dome_status_group.pairs['dome_status'].value_label)
        except Exception as e:
            print(f"å…³é—­åœ†é¡¶æ—¶å‡ºé”™: {str(e)}")
            import traceback
            traceback.print_exc()
            # æ¢å¤UIçŠ¶æ€
            self.dome_status_group.pairs['dome_status'].set_value(f"é”™è¯¯: {str(e)}")
            self.dome_status_group.pairs['dome_status'].value_label.setProperty('class', 'medium-text status-error')
            self.dome_status_group.pairs['dome_status'].value_label.style().unpolish(self.dome_status_group.pairs['dome_status'].value_label)
            self.dome_status_group.pairs['dome_status'].value_label.style().polish(self.dome_status_group.pairs['dome_status'].value_label)
        finally:
            # é‡æ–°å¯ç”¨æŒ‰é’®
            print("é‡æ–°å¯ç”¨åœ†é¡¶å¼€å…³æŒ‰é’®")
            self.dome_open_button.setEnabled(True)
            self.dome_close_button.setEnabled(True)

    def open_cover(self):
        """æ‰“å¼€é•œå¤´ç›–"""
        # æŸ¥æ‰¾æ˜¯å¦æœ‰å·²è¿æ¥çš„é•œå¤´ç›–è®¾å¤‡
        cover_device = None
        device_number = 0
        
        for control in self.device_controls:
            if hasattr(control, 'device_id') and control.device_id == 'cover' and control.is_connected:
                cover_device = control
                # è·å–è®¾å¤‡å·
                current_index = control.combo.currentIndex()
                if current_index >= 0:
                    device_data = control.combo.itemData(current_index)
                    if device_data and 'DeviceNumber' in device_data:
                        device_number = device_data['DeviceNumber']
                break
        
        if not cover_device:
            print("æœªæ‰¾åˆ°å·²è¿æ¥çš„é•œå¤´ç›–è®¾å¤‡")
            return
        
        print(f"å‡†å¤‡æ‰“å¼€é•œå¤´ç›–ï¼Œè®¾å¤‡å·ï¼š{device_number}")
            
        # æ›´æ–°UIæ˜¾ç¤ºï¼Œè¡¨ç¤ºæ­£åœ¨æ“ä½œ
        self.telescope_status.pairs['cover_status'].set_value("æ­£åœ¨æ‰“å¼€é•œå¤´ç›–...")
        self.telescope_status.pairs['cover_status'].value_label.setProperty('class', 'medium-text status-warning')
        self.telescope_status.pairs['cover_status'].value_label.style().unpolish(self.telescope_status.pairs['cover_status'].value_label)
        self.telescope_status.pairs['cover_status'].value_label.style().polish(self.telescope_status.pairs['cover_status'].value_label)
        print("å·²æ›´æ–°UIçŠ¶æ€ä¸º'æ­£åœ¨æ‰“å¼€é•œå¤´ç›–...'")
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        self.cover_open_button.setEnabled(False)
        self.cover_close_button.setEnabled(False)
        print("å·²ç¦ç”¨é•œå¤´ç›–å¼€å…³æŒ‰é’®")
        
        try:
            # åˆ›å»ºAlpacaClientå®ä¾‹
            print("å¼€å§‹å¯¼å…¥AlpacaClient...")
            import time
            start_time = time.time()
            from api_client import AlpacaClient
            from utils import load_config
            print(f"å¯¼å…¥AlpacaClientå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            print("å¼€å§‹åˆ›å»ºAlpacaClientå®ä¾‹...")
            start_time = time.time()
            config = load_config()
            base_url = config.get("devices", {}).get("covercalibrator", {}).get("api_url")
            if not base_url:
                base_url = "http://202.127.24.217:11111"  # é»˜è®¤ URL
            print(f"ä½¿ç”¨API URL: {base_url}")
            client = AlpacaClient(base_url=base_url)
            print(f"åˆ›å»ºAlpacaClientå®ä¾‹å®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            # è°ƒç”¨APIæ‰“å¼€é•œå¤´ç›–
            print(f"å¼€å§‹è°ƒç”¨APIæ‰“å¼€é•œå¤´ç›–ï¼Œè®¾å¤‡å·ï¼š{device_number}...")
            start_time = time.time()
            success = client.open_cover(device_number)
            print(f"è°ƒç”¨APIå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’ï¼Œç»“æœï¼š{success}")
            
            if success:
                print(f"æˆåŠŸå‘é€æ‰“å¼€é•œå¤´ç›–å‘½ä»¤ï¼Œè®¾å¤‡å·: {device_number}")
            else:
                print(f"å‘é€æ‰“å¼€é•œå¤´ç›–å‘½ä»¤å¤±è´¥ï¼Œè®¾å¤‡å·: {device_number}")
                # æ¢å¤UIçŠ¶æ€
                self.telescope_status.pairs['cover_status'].set_value("æ‰“å¼€é•œå¤´ç›–å¤±è´¥")
                self.telescope_status.pairs['cover_status'].value_label.setProperty('class', 'medium-text status-error')
                self.telescope_status.pairs['cover_status'].value_label.style().unpolish(self.telescope_status.pairs['cover_status'].value_label)
                self.telescope_status.pairs['cover_status'].value_label.style().polish(self.telescope_status.pairs['cover_status'].value_label)
        except Exception as e:
            print(f"æ‰“å¼€é•œå¤´ç›–æ—¶å‡ºé”™: {str(e)}")
            import traceback
            traceback.print_exc()
            # æ¢å¤UIçŠ¶æ€
            self.telescope_status.pairs['cover_status'].set_value(f"é”™è¯¯: {str(e)}")
            self.telescope_status.pairs['cover_status'].value_label.setProperty('class', 'medium-text status-error')
            self.telescope_status.pairs['cover_status'].value_label.style().unpolish(self.telescope_status.pairs['cover_status'].value_label)
            self.telescope_status.pairs['cover_status'].value_label.style().polish(self.telescope_status.pairs['cover_status'].value_label)
        finally:
            # é‡æ–°å¯ç”¨æŒ‰é’®
            print("é‡æ–°å¯ç”¨é•œå¤´ç›–å¼€å…³æŒ‰é’®")
            self.cover_open_button.setEnabled(True)
            self.cover_close_button.setEnabled(True)

    def close_cover(self):
        """å…³é—­é•œå¤´ç›–"""
        # æŸ¥æ‰¾æ˜¯å¦æœ‰å·²è¿æ¥çš„é•œå¤´ç›–è®¾å¤‡
        cover_device = None
        device_number = 0
        
        for control in self.device_controls:
            if hasattr(control, 'device_id') and control.device_id == 'cover' and control.is_connected:
                cover_device = control
                # è·å–è®¾å¤‡å·
                current_index = control.combo.currentIndex()
                if current_index >= 0:
                    device_data = control.combo.itemData(current_index)
                    if device_data and 'DeviceNumber' in device_data:
                        device_number = device_data['DeviceNumber']
                break
        
        if not cover_device:
            print("æœªæ‰¾åˆ°å·²è¿æ¥çš„é•œå¤´ç›–è®¾å¤‡")
            return
            
        print(f"å‡†å¤‡å…³é—­é•œå¤´ç›–ï¼Œè®¾å¤‡å·ï¼š{device_number}")
            
        # æ›´æ–°UIæ˜¾ç¤ºï¼Œè¡¨ç¤ºæ­£åœ¨æ“ä½œ
        self.telescope_status.pairs['cover_status'].set_value("æ­£åœ¨å…³é—­é•œå¤´ç›–...")
        self.telescope_status.pairs['cover_status'].value_label.setProperty('class', 'medium-text status-warning')
        self.telescope_status.pairs['cover_status'].value_label.style().unpolish(self.telescope_status.pairs['cover_status'].value_label)
        self.telescope_status.pairs['cover_status'].value_label.style().polish(self.telescope_status.pairs['cover_status'].value_label)
        print("å·²æ›´æ–°UIçŠ¶æ€ä¸º'æ­£åœ¨å…³é—­é•œå¤´ç›–...'")
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        self.cover_open_button.setEnabled(False)
        self.cover_close_button.setEnabled(False)
        print("å·²ç¦ç”¨é•œå¤´ç›–å¼€å…³æŒ‰é’®")
        
        try:
            # åˆ›å»ºAlpacaClientå®ä¾‹
            print("å¼€å§‹å¯¼å…¥AlpacaClient...")
            import time
            start_time = time.time()
            from api_client import AlpacaClient
            from utils import load_config
            print(f"å¯¼å…¥AlpacaClientå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            print("å¼€å§‹åˆ›å»ºAlpacaClientå®ä¾‹...")
            start_time = time.time()
            config = load_config()
            base_url = config.get("devices", {}).get("covercalibrator", {}).get("api_url")
            if not base_url:
                base_url = "http://202.127.24.217:11111"  # é»˜è®¤ URL
            print(f"ä½¿ç”¨API URL: {base_url}")
            client = AlpacaClient(base_url=base_url)
            print(f"åˆ›å»ºAlpacaClientå®ä¾‹å®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’")
            
            # è°ƒç”¨APIå…³é—­é•œå¤´ç›–
            print(f"å¼€å§‹è°ƒç”¨APIå…³é—­é•œå¤´ç›–ï¼Œè®¾å¤‡å·ï¼š{device_number}...")
            start_time = time.time()
            success = client.close_cover(device_number)
            print(f"è°ƒç”¨APIå®Œæˆï¼Œè€—æ—¶ï¼š{time.time() - start_time:.3f}ç§’ï¼Œç»“æœï¼š{success}")
            
            if success:
                print(f"æˆåŠŸå‘é€å…³é—­é•œå¤´ç›–å‘½ä»¤ï¼Œè®¾å¤‡å·: {device_number}")
            else:
                print(f"å‘é€å…³é—­é•œå¤´ç›–å‘½ä»¤å¤±è´¥ï¼Œè®¾å¤‡å·: {device_number}")
                # æ¢å¤UIçŠ¶æ€
                self.telescope_status.pairs['cover_status'].set_value("å…³é—­é•œå¤´ç›–å¤±è´¥")
                self.telescope_status.pairs['cover_status'].value_label.setProperty('class', 'medium-text status-error')
                self.telescope_status.pairs['cover_status'].value_label.style().unpolish(self.telescope_status.pairs['cover_status'].value_label)
                self.telescope_status.pairs['cover_status'].value_label.style().polish(self.telescope_status.pairs['cover_status'].value_label)
        except Exception as e:
            print(f"å…³é—­é•œå¤´ç›–æ—¶å‡ºé”™: {str(e)}")
            import traceback
            traceback.print_exc()
            # æ¢å¤UIçŠ¶æ€
            self.telescope_status.pairs['cover_status'].set_value(f"é”™è¯¯: {str(e)}")
            self.telescope_status.pairs['cover_status'].value_label.setProperty('class', 'medium-text status-error')
            self.telescope_status.pairs['cover_status'].value_label.style().unpolish(self.telescope_status.pairs['cover_status'].value_label)
            self.telescope_status.pairs['cover_status'].value_label.style().polish(self.telescope_status.pairs['cover_status'].value_label)
        finally:
            # é‡æ–°å¯ç”¨æŒ‰é’®
            print("é‡æ–°å¯ç”¨é•œå¤´ç›–å¼€å…³æŒ‰é’®")
            self.cover_open_button.setEnabled(True)
            self.cover_close_button.setEnabled(True)

    def add_manual_cover_device(self):
        """æ‰‹åŠ¨æ·»åŠ é•œå¤´ç›–è®¾å¤‡åˆ°è®¾å¤‡åˆ—è¡¨"""
        # åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„é•œå¤´ç›–è®¾å¤‡
        default_device = {
            'DeviceName': 'ASCOM CoverCalibrator (æ‰‹åŠ¨æ·»åŠ )',
            'DeviceType': 'CoverCalibrator',
            'DeviceNumber': 0,
            'ApiVersion': '1.0'
        }
        
        # æŸ¥æ‰¾coverè®¾å¤‡æ§åˆ¶ç»„ä»¶
        for control in self.device_controls:
            if hasattr(control, 'device_id') and control.device_id == 'cover':
                # å…ˆæ–­å¼€ç°æœ‰è¿æ¥
                if control.is_connected:
                    control.toggle_connection()
                
                # æ›´æ–°è®¾å¤‡åˆ—è¡¨
                device_list = [default_device]
                control.update_devices(device_list)
                
                # è®¾ç½®å·²æ·»åŠ é»˜è®¤è®¾å¤‡æ ‡å¿—
                self.has_added_default_cover_device = True
                
                # åˆ·æ–°è®¾å¤‡åˆ—è¡¨ï¼Œç¡®ä¿åœ¨èœå•ä¸­æ˜¾ç¤º
                from api_client import AlpacaClient
                client = AlpacaClient()
                devices = client.find_devices()
                
                # ç¡®ä¿è®¾å¤‡åˆ—è¡¨ä¸­åŒ…å«é»˜è®¤é•œå¤´ç›–è®¾å¤‡
                has_cover_device = any(dev.get('DeviceType') == 'CoverCalibrator' for dev in devices)
                if not has_cover_device:
                    devices.append(default_device)
                
                # æ›´æ–°è¿æ¥èœå•
                self.init_connect_menu(devices)
                
                # æç¤ºç”¨æˆ·å·²æ·»åŠ è®¾å¤‡
                print("å·²æ‰‹åŠ¨æ·»åŠ é•œå¤´ç›–è®¾å¤‡")
                break